{% extends "layout.html" %}
{% block content %}
<div class="matrix-page">

  <h2 style="margin-bottom:0;">ğŸ§  æ„Ÿæƒ… Ã— åˆ©ç›Šãƒãƒˆãƒªã‚¯ã‚¹</h2>

<div style="display: flex; gap: 8px; align-items: center; margin-bottom: 1em;">
  <form method="get" style="display:inline;">
    <input type="hidden" name="sort" value="date_desc">
    <button type="submit" {% if sort == "date_desc" %}disabled{% endif %}>æ—¥ä»˜ã®æ–°ã—ã„é †</button>
  </form>
  <form method="get" style="display:inline;">
    <input type="hidden" name="sort" value="date_asc">
    <button type="submit" {% if sort == "date_asc" %}disabled{% endif %}>æ—¥ä»˜ã®å¤ã„é †</button>
  </form>
  <form method="get" style="display:inline;">
    <input type="hidden" name="sort" value="profit_desc">
    <button type="submit" {% if sort == "profit_desc" %}disabled{% endif %}>åˆ©ç›ŠãŒå¤§ãã„é †</button>
  </form>
  <form method="get" style="display:inline;">
    <input type="hidden" name="sort" value="profit_asc">
    <button type="submit" {% if sort == "profit_asc" %}disabled{% endif %}>æå¤±ãŒå¤§ãã„é †</button>
  </form>
</div>


  <!-- æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆãã®ã¾ã¾ï¼‰ -->
  <div style="width:100%; max-width:1200px; margin:0 auto 1em auto; display:flex; justify-content:flex-end;">
    <form method="get" action="/matrix" style="display:flex; gap:4px; align-items:center;">
      <input type="text" name="q" placeholder="æ¤œç´¢" value="{{ request.args.get('q', '') }}" style="width: 140px;">
      <button type="submit">æ¤œç´¢</button>
      <button type="button" id="clear-btn">ã‚¯ãƒªã‚¢</button>
    </form>
  </div>

  <div class="trade-list">

    {% set feelings = ['', 'ğŸ˜– ãƒã‚¬ãƒ†ã‚£ãƒ–', 'ğŸ˜ ã‚„ã‚„ä¸å®‰', 'ğŸ˜ ãµã¤ã†', 'ğŸ™‚ ã¾ã‚ã¾ã‚', 'ğŸ˜„ ãƒãƒƒãƒ”ãƒ¼'] %}


{% for row in results %}
<div class="trade-card">
  <div class="trade-row">
    <span class="stock-name">{{ row[7] or 'ï¼ˆéŠ˜æŸ„åï¼‰' }}</span>
    <span class="trade-date">{{ row[8] }}</span>
    <span class="trade-profit {% if row[0]|int > 0 %}profit{% else %}loss{% endif %}">{{ "{:+,}".format(row[0]|int) }}å††</span>
  </div>
<div class="trade-info-row">
  <span class="feeling-icon entry">{{ feelings[row[1] or 0].split()[0] }}</span>
  <span class="arrow">â‡’</span>
  <span class="feeling-icon exit">{{ feelings[row[2] or 0].split()[0] }}</span>
<span class="purpose-label" style="display: inline-flex; align-items: center; gap: 4px;">
  {% set pid = row[9]|int %}
  {% if pid == 1 %}
    <span class="purpose-icon">ğŸ’¹</span>çŸ­æœŸ
  {% elif pid == 2 %}
    <span class="purpose-icon">ğŸ“Š</span>ä¸­æœŸ
  {% elif pid == 3 %}
    <span class="purpose-icon">ğŸ“ˆ</span>é•·æœŸ
  {% elif pid == 4 %}
    <span class="purpose-icon">ğŸ</span>å„ªå¾…
  {% elif pid == 5 %}
    <span class="purpose-icon">ğŸ’°</span>é…å½“
  {% else %}
    â€•
  {% endif %}
</span>

  <span class="memo-toggle" onclick="toggleMemo(this, event)">ãƒ¡ãƒ¢â–¼</span>
  <a href="/history?id={{ row[6] }}" class="history-link">è©³ç´°</a>
</div>

  <div class="trade-memo" style="display:none;">
    <span class="memo-entry"><b>ã‚¨ãƒ³ãƒˆãƒªãƒ¼</b>: {{ row[4] }}</span>
    <span class="memo-exit"><b>æ±ºæ¸ˆ</b>: {{ row[5] }}</span>
  </div>
</div>




{% endfor %}




  </div>

  <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãã®ã¾ã¾ï¼‰ -->
  <div class="pagination" style="text-align:center; margin: 16px 0;">
    {% if page > 1 %}
      <a href="?page={{ page - 1 }}">Â« å‰ã¸</a>
    {% endif %}
    <span style="margin:0 8px;">{{ page }} / {{ total_pages }}</span>
    {% if page < total_pages %}
      <a href="?page={{ page + 1 }}">æ¬¡ã¸ Â»</a>
    {% endif %}
  </div>
</div>



<script>
function toggleMatrixMemo(button, baseId) {
  const shortText = document.getElementById(baseId);
  const fullDiv = document.getElementById(baseId + "-full");
  const openBtn = document.getElementById("memo-toggle-" + baseId);
  const closeBtn = document.getElementById("memo-toggle-close-" + baseId);

  if (fullDiv.style.display === "none" || !fullDiv.style.display) {
    // å…¨æ–‡è¡¨ç¤º
    if (shortText) shortText.style.display = "none";
    if (openBtn) openBtn.style.display = "none";
    if (fullDiv) fullDiv.style.display = "flex";
    if (closeBtn) closeBtn.style.display = "inline-block";
  } else {
    // æŠ˜ã‚Šç•³ã¿è¡¨ç¤º
    if (shortText) shortText.style.display = "";
    if (openBtn) openBtn.style.display = "inline-block";
    if (fullDiv) fullDiv.style.display = "none";
    if (closeBtn) closeBtn.style.display = "none";
  }
}




var clearBtn = document.getElementById('clear-btn');
if (clearBtn) {
  clearBtn.onclick = function() {
    window.location.href = '/matrix';
  };
}



</script>

<script>
function toggleDetail(card) {
  const detail = card.querySelector('.trade-detail');
  const toggle = card.querySelector('.expand-toggle');
  if (!detail || !toggle) return;
  if (detail.style.display === "none" || !detail.style.display) {
    detail.style.display = "block";
    toggle.textContent = "â–²";
  } else {
    detail.style.display = "none";
    toggle.textContent = "â–¼";
  }
}

function toggleMemo(el, event) {
  event.stopPropagation();
  const memo = el.closest('.trade-card').querySelector('.trade-memo');
  if (memo.style.display === 'none' || !memo.style.display) {
    memo.style.display = 'block';
    el.textContent = 'ãƒ¡ãƒ¢åç´â–²';
  } else {
    memo.style.display = 'none';
    el.textContent = 'ãƒ¡ãƒ¢å±•é–‹â–¼';
  }
}





</script>






</body>






{% endblock %}
