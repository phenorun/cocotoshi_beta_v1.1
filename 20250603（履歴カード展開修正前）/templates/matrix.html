{% extends "layout.html" %}
{% block content %}
<div class="matrix-page">

  <h2 style="margin-bottom:0;">ğŸ§  æ„Ÿæƒ… Ã— åˆ©ç›Šãƒãƒˆãƒªã‚¯ã‚¹</h2>

  <!-- æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆãã®ã¾ã¾ï¼‰ -->
  <div style="width:100%; max-width:1200px; margin:0 auto 1em auto; display:flex; justify-content:flex-end;">
    <form method="get" action="/matrix" style="display:flex; gap:4px; align-items:center;">
      <input type="text" name="q" placeholder="æ¤œç´¢" value="{{ request.args.get('q', '') }}" style="width: 140px;">
      <button type="submit">æ¤œç´¢</button>
      <button type="button" id="clear-btn">ã‚¯ãƒªã‚¢</button>
    </form>
  </div>

  <div class="trade-list">

    {% set feelings = ['', 'ğŸ˜– ãƒã‚¬ãƒ†ã‚£ãƒ–', 'ğŸ˜ ã‚„ã‚„ä¸å®‰', 'ğŸ˜ ãµã¤ã†', 'ğŸ™‚ ã¾ã‚ã¾ã‚', 'ğŸ˜„ ãƒãƒƒãƒ”ãƒ¼'] %}
    {% for row in results %}
      <div class="matrix-card">
        <!-- 1æ®µç›® -->
        <div class="matrix-row-top">
          <span class="stock-name">{{ row[7] or 'ï¼ˆéŠ˜æŸ„åï¼‰' }}</span>
          <span class="{{ 'profit-positive' if row[0]|int >=0 else 'profit-negative' }}" style="margin-left:1em;">{{ "{:+,}".format(row[0]|int) }}å††</span>
          <span style="margin-left:1em;">ä¿æœ‰: {{ row[3] }}æ—¥</span>
        </div>
        <!-- 2æ®µç›®ï¼ˆæ„Ÿæƒ…ã¨ãƒ¡ãƒ¢ã‚’æ¨ªä¸¦ã³ãƒ»2æ®µæ§‹æˆï¼‰ -->




{% set entry_text = row[4]|default('') %}
<div class="matrix-row-pair">
  <span class="matrix-label">ã‚¨ãƒ³ãƒˆãƒªãƒ¼ï¼š</span>
  <span class="feeling-{{ row[1] or 0 }}">{{ feelings[row[1] or 0] }}</span>
  <span class="matrix-memo">
    <span class="matrix-memo-text" id="entry-{{ loop.index }}">
      {{ (entry_text.splitlines()[0] if entry_text|length > 0 else '&nbsp;')|safe }}
      {% if entry_text|length > 0 and (entry_text.splitlines()|length > 1 or entry_text|length > 32) %}â€¦{% endif %}
    </span>
    {% if entry_text|length > 0 and (entry_text.splitlines()|length > 1 or entry_text|length > 32) %}
      <button class="memo-toggle"
        onclick="toggleMatrixMemo(this, 'entry-{{ loop.index }}')">â–¼ ç¶šãã‚’è¦‹ã‚‹</button>
      <!-- â†“ã“ã“ã‚’textareaã‹ã‚‰divã«ä¿®æ­£ -->
      <div id="entry-{{ loop.index }}-full" style="display:none; white-space:pre-line;">{{ entry_text }}</div>
    {% endif %}
  </span>
</div>


{% set settle_text = row[5]|default('') %}
<div class="matrix-row-pair">
  <span class="matrix-label">æ±ºã€€æ¸ˆã€€ï¼š</span>
  <span class="feeling-{{ row[2] or 0 }}">{{ feelings[row[2] or 0] }}</span>
  <span class="matrix-memo">
    <span class="matrix-memo-text" id="settle-{{ loop.index }}">
      {{ (settle_text.splitlines()[0] if settle_text|length > 0 else '&nbsp;')|safe }}
      {% if settle_text|length > 0 and (settle_text.splitlines()|length > 1 or settle_text|length > 32) %}â€¦{% endif %}
    </span>
    {% if settle_text|length > 0 and (settle_text.splitlines()|length > 1 or settle_text|length > 32) %}
      <button class="memo-toggle"
        onclick="toggleMatrixMemo(this, 'settle-{{ loop.index }}')">â–¼ ç¶šãã‚’è¦‹ã‚‹</button>
      <!-- â†“ã“ã“ã‚’textareaã‹ã‚‰divã«ä¿®æ­£ -->
      <div id="settle-{{ loop.index }}-full" style="display:none; white-space:pre-line;">{{ settle_text }}</div>
    {% endif %}
  </span>
</div>










        <!-- è©³ç´°ãƒªãƒ³ã‚¯ -->
        <div style="text-align:right;margin-top:3px;">
          <a href="/history?id={{ row[6] }}" class="history-link">ğŸ”—è©³ç´°</a>
        </div>
      </div>
    {% endfor %}

  </div>

  <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãã®ã¾ã¾ï¼‰ -->
  <div class="pagination" style="text-align:center; margin: 16px 0;">
    {% if page > 1 %}
      <a href="?page={{ page - 1 }}">Â« å‰ã¸</a>
    {% endif %}
    <span style="margin:0 8px;">{{ page }} / {{ total_pages }}</span>
    {% if page < total_pages %}
      <a href="?page={{ page + 1 }}">æ¬¡ã¸ Â»</a>
    {% endif %}
  </div>
</div>



<script>
window.toggleMatrixMemo = function (btn, memoId) {
    // å„ãƒãƒ¼ãƒ‰å–å¾—
    let fullTextNode = document.getElementById(memoId + "-full");
    let memoSpan = document.getElementById(memoId);

    // ç¢ºèªç”¨ãƒ­ã‚°
    console.log("fullTextNode:", fullTextNode);
    console.log("memoSpan:", memoSpan);

    if (!fullTextNode || !memoSpan) return;

    // ç¾åœ¨ã®è¡¨ç¤ºçŠ¶æ…‹
    const isOpen = fullTextNode.style.display !== "none";
    console.log("isOpen:", isOpen);

    if (isOpen) {
        // ã€Œå…¨æ–‡è¡¨ç¤ºä¸­ã€â†’çŸ­ç¸®ã«æˆ»ã™
        fullTextNode.style.display = "none";
        memoSpan.style.display = "";
        btn.textContent = "â–¼ ç¶šãã‚’è¦‹ã‚‹";
    } else {
        // ã€ŒçŸ­ç¸®è¡¨ç¤ºã€â†’å…¨æ–‡è¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ãˆ
        fullTextNode.style.display = "";
        memoSpan.style.display = "none";
        btn.textContent = "â–² é–‰ã˜ã‚‹";
    }
};




var clearBtn = document.getElementById('clear-btn');
if (clearBtn) {
  clearBtn.onclick = function() {
    window.location.href = '/matrix';
  };
}



</script>



</body>






{% endblock %}
