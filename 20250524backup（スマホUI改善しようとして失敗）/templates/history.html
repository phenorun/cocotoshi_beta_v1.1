{% extends "layout.html" %}
{% block title %}å–å¼•å±¥æ­´ä¸€è¦§{% endblock %}
{% block content %}

<div style="display: flex; justify-content: space-between; align-items: center;">
  <h1 style="margin-bottom: 0;">å–å¼•å±¥æ­´ä¸€è¦§</h1>
  <form method="get" action="/history" id="search-form" style="display:flex; gap:4px; align-items:center; margin-bottom:0;">
    <input 
      type="text" 
      name="q" 
      placeholder="æ¤œç´¢" 
      value="{{ request.args.get('q', '') }}" 
      style="width: 160px; height: 2em; font-size: 1em; padding: 2px 8px;"
    >
    <button type="submit" style="height:2em;">æ¤œç´¢</button>
    <button type="button" id="clear-btn" style="height:2em;">ã‚¯ãƒªã‚¢</button>
  </form>
</div>
<a href="/form" class="new-register-btn">ï¼‹æ–°è¦ç™»éŒ²</a>
<div class="trade-list">
  {% for item in trade_tree %}
    {% set parent = item.parent %}
    {% set children = item.children %}
    {% set remaining = item.remaining %}
    {% set total_profit = item.total_profit %}
<div class="trade-card parent{% if item.is_completed %} completed{% endif %}" data-trade-id="{{ parent.id }}">
  <div class="trade-type-label {{ parent.type }}">
    {{ 'ğŸ“¥ è²·ã„' if parent.type == 'buy' else 'ğŸ“¤ å£²ã‚Š' if parent.type == 'sell' else 'ğŸ‘€ ã‚¦ã‚©ãƒƒãƒ' }}
  </div>
  {% if item.is_completed %}
  <span class="soldout-label">å®Œå£²</span>
  {% endif %}
<div class="trade-row">
  <strong>éŠ˜æŸ„:</strong>
  <span class="stock-highlight">
    <span class="stock-name">{{ parent.stock }}</span>
    ï¼ˆ{{ parent.code }}ï¼‰
  </span>
</div>
  <div class="trade-row" style="display:flex; align-items:center;">
    {% if item.average_price is not none %}
      <span class="avg-label">ğŸ“Š å¹³å‡å–å¾—æ ªä¾¡:</span>
      <span class="avg-value">{{ "{:,}".format(item.average_price|int) }}å††</span>
    {% endif %}
    <span class="stock-remaining">æ®‹æ ªæ•°: {{ remaining }} æ ª</span>
  </div>
  <div class="trade-row"><strong>æ—¥ä»˜:</strong> {{ parent.date }}</div>
  <div class="trade-row">
    <strong>æ„Ÿæƒ…:</strong>
    <span class="feeling-{{ parent.feeling }}">
      {{ ['','ğŸ˜– ãƒã‚¬ãƒ†ã‚£ãƒ–','ğŸ˜ ã‚„ã‚„ä¸å®‰','ğŸ˜ ãµã¤ã†','ğŸ™‚ ã¾ã‚ã¾ã‚','ğŸ˜„ ãƒãƒƒãƒ”ãƒ¼'][parent.feeling] }}
    </span>
  </div>
    <div class="trade-row">
    <strong>ğŸ’° åˆè¨ˆåˆ©ç›Š:</strong>
    <span class="{% if total_profit >= 0 %}profit-positive{% else %}profit-negative{% endif %}">
      {{ "{:,}".format(total_profit|int) }} å††
    </span>
   </div>
{% if parent.purpose %}
  {% set purpose_map = {
    'çŸ­æœŸ': 'short', 'ä¸­æœŸ': 'middle', 'é•·æœŸ': 'long', 'å„ªå¾…': 'benefit', 'é…å½“': 'dividend',
    'short': 'short', 'middle': 'middle', 'long': 'long', 'benefit': 'benefit', 'dividend': 'dividend'
  } %}
  {% set p = purpose_map.get(parent.purpose, parent.purpose) %}
  <div class="trade-row" style="display:flex; align-items:center;">
    <strong style="margin-right:8px;">ç›®çš„:</strong>
    <span class="purpose-label" style="display:inline-flex; align-items:center; gap:4px;">
      {% if p == "short" %}
        <span class="purpose-icon">ğŸ’¹</span>çŸ­æœŸ
      {% elif p == "middle" %}
        <span class="purpose-icon">ğŸ“Š</span>ä¸­æœŸ
      {% elif p == "long" %}
        <span class="purpose-icon">ğŸ“ˆ</span>é•·æœŸ
      {% elif p == "benefit" %}
        <span class="purpose-icon">ğŸ</span>å„ªå¾…
      {% elif p == "dividend" %}
        <span class="purpose-icon">ğŸ’°</span>é…å½“
      {% else %}
        <span class="purpose-icon">â—†</span>{{ parent.purpose }}
      {% endif %}
    </span>
  </div>
{% endif %}
      <div class="trade-actions">
        <button class="action-btn buy open-modal"
          data-id="{{ parent.id }}" data-type="buy"
           data-stock="{{ parent.stock }}" data-price="{{ parent.price }}"
         data-quantity="{{ parent.quantity }}"
          data-purpose="{{ parent.purpose }}">ï¼‹è²·ã„</button>
        <button class="action-btn sell open-modal"
          data-id="{{ parent.id }}" data-type="sell"
           data-stock="{{ parent.stock }}" data-price="{{ parent.price }}"
           data-quantity="{{ parent.quantity }}"
           data-purpose="{{ parent.purpose }}">âˆ’å£²ã‚Š</button>
          <a href="#" class="edit-link"
            data-id="{{ parent.id }}"
            data-type="{{ parent.type }}"
            data-stock="{{ parent.stock }}"
            data-code="{{ parent.code }}"
            data-price="{{ parent.price }}"
            data-quantity="{{ parent.quantity }}"
            data-total="{{ parent.total }}"
            data-date="{{ parent.date }}"
            data-feeling="{{ parent.feeling }}"
            data-purpose="{{ parent.purpose }}"
            data-memo="{{ parent.memo }}"
          >ç·¨é›†</a>
        <a href="#" class="delete-link" data-href="/delete/{{ parent.id }}">å‰Šé™¤</a>
      </div>
      {% if children|length > 0 %}
       <div class="has-children-badge">ï¼‹ è¿½åŠ å£²è²·å±¥æ­´ã‚ã‚Šï¼ˆã‚¿ãƒƒãƒ—ã§è¡¨ç¤ºï¼‰</div>
      {% endif %}
      <!-- å­ã‚«ãƒ¼ãƒ‰ãŸã¡ -->
  <div class="child-cards children-wrap{% if item.is_completed %} collapsed{% endif %}" data-trade-id="{{ parent.id }}">
    {% for child in children %}
      {% set child_label = (
        'è²·ã„å¢—ã—' if parent.type == 'buy' and child.type == 'buy' else
        'å£²å´'     if parent.type == 'buy' and child.type == 'sell' else
        'å£²ã‚Šå¢—ã—' if parent.type == 'sell' and child.type == 'sell' else
        'è²·ã„æˆ»ã—' if parent.type == 'sell' and child.type == 'buy' else
        'å–å¼•'
      ) %}
    <div class="trade-card child{% if item.is_completed %} completed{% endif %}">
      <div class="trade-row" style="display:flex; align-items:center;">
        <span class="trade-type-label trade-type-{{ child.type }}">
          {{ child_label }}
        </span>
        <span style="margin-left:12px;">
          {{ child.quantity }}æ ª @ {{ child.price|int }}å††
        </span>
      </div>
      <div class="trade-children{% if item.is_completed %} collapsed{% endif %}">
      </div>
        <div class="trade-row"><strong>æ—¥ä»˜:</strong> {{ child.date }}</div>
        <div class="trade-row"><strong>æ„Ÿæƒ…:</strong>
          <span class="feeling-{{ child.feeling }}">
            {{ ['','ğŸ˜– ãƒã‚¬ãƒ†ã‚£ãƒ–','ğŸ˜ ã‚„ã‚„ä¸å®‰','ğŸ˜ ãµã¤ã†','ğŸ™‚ ã¾ã‚ã¾ã‚','ğŸ˜„ ãƒãƒƒãƒ”ãƒ¼'][child.feeling] }}
          </span>
        </div>
        {% if child.profits is defined and child.profits|length > 0 %}
         {% for profit in child.profits %}
         <div class="trade-row">
           <strong>ğŸ“ˆ åˆ©ç›Š:</strong>
           <span class="{% if profit >= 0 %}profit-positive{% else %}profit-negative{% endif %}">
             {{ "{:,}".format(profit|int) }} å††
           </span>
             </div>
          {% endfor %}
          {% endif %}
            <div class="trade-actions">
              <a href="#" class="edit-link"
                  data-id="{{ child.id }}"
                   data-type="{{ child.type }}"
                 data-stock="{{ child.stock }}"
                  data-code="{{ child.code }}"
                  data-price="{{ child.price }}"
                  data-quantity="{{ child.quantity }}"
                  data-total="{{ child.total }}"
                  data-date="{{ child.date }}"
                  data-feeling="{{ child.feeling }}"
                  data-purpose="{{ child.purpose }}"
                  data-memo="{{ child.memo }}"
                  data-parent-id="{{ child.parent_id }}"
              >ç·¨é›†</a>
              <a href="#" class="delete-link" data-href="/delete/{{ child.id }}">å‰Šé™¤</a>
            </div>
          </div>
        {% endfor %}
      </div>
      <!-- /child-cards -->
    </div>
  {% endfor %}
</div>
<!-- ä»¥é™ã®å„ç¨®ãƒ¢ãƒ¼ãƒ€ãƒ«/ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚‚ãã®ã¾ã¾è²¼ã£ã¦OKï¼ˆå†…å®¹ç•¥ï¼‰ -->
{% endblock %}
