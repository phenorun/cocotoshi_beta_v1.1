{% extends "layout.html" %}
{% block title %}å–å¼•å±¥æ­´ä¸€è¦§{% endblock %}
{% block content %}

<h1>å–å¼•å±¥æ­´ä¸€è¦§</h1>
<a href="/form">æ–°è¦ç™»éŒ²</a>

<div class="trade-list">
  {% for item in trade_tree %}
    {% set parent = item.parent %}
    {% set children = item.children %}
    {% set remaining = item.remaining %}
    {% set total_profit = item.total_profit %}



    <!-- è¦ªã‚«ãƒ¼ãƒ‰ -->
    <div class="trade-card parent">
      <div class="trade-type-label {{ parent.type }}">
        {{ 'ğŸ“¥ è²·ã„' if parent.type == 'buy' else 'ğŸ“¤ å£²ã‚Š' if parent.type == 'sell' else 'ğŸ‘€ ã‚¦ã‚©ãƒƒãƒ' }}
      </div>

      <div class="trade-row">
        <strong>ğŸ“ˆ éŠ˜æŸ„:</strong>
         {% if parent.code %}
          {{ parent.code }}ï¼ˆ{{ parent.stock }}ï¼‰
           {% else %}
           {{ parent.stock }}
           {% endif %}
           ï¼ˆ{{ parent.quantity }}æ ª @ {{ parent.price }}å††ï¼‰
      </div>

            {% set average_price = item.average_price %}
            {% if average_price is not none %}
           <div class="trade-row">
           <strong>ğŸ“Š å¹³å‡å–å¾—æ ªä¾¡:</strong> {{ average_price|round(2) }} å††
           </div>
            {% endif %}



      <div class="trade-row"><strong>æ—¥ä»˜:</strong> {{ parent.date }}</div>
      <div class="trade-row"><strong>æ®‹æ ªæ•°:</strong> {{ remaining }} æ ª</div>
      <div class="trade-row"><strong>æ„Ÿæƒ…:</strong>
        <span class="feeling-{{ parent.feeling }}">
          {{ ['','ğŸ˜– ãƒã‚¬ãƒ†ã‚£ãƒ–','ğŸ˜ ã‚„ã‚„ä¸å®‰','ğŸ˜ ãµã¤ã†','ğŸ™‚ ã¾ã‚ã¾ã‚','ğŸ˜„ ãƒãƒƒãƒ”ãƒ¼'][parent.feeling] }}
        </span>
      </div>
      {% if total_profit != 0 %}
           <div class="trade-row"><strong>ğŸ’° ãƒ„ãƒªãƒ¼åˆè¨ˆåˆ©ç›Š:</strong> {{ total_profit|round(2) }} å††</div>
      {% endif %}

      {% if total_profit != 0 %}
      <div class="trade-row">
      <strong>ğŸ’° åˆ©ç›Š:</strong> {{ total_profit }} å††
      </div>
      {% endif %}

      {% if parent.purpose %}
      <div class="trade-row"><strong>ç›®çš„:</strong> 
        {% if parent.purpose == "long" %} ğŸ“ˆ é•·æœŸ
        {% elif parent.purpose == "short" %} ğŸ’¹ çŸ­æœŸ
        {% elif parent.purpose == "dividend" %} ğŸ’° é…å½“
        {% elif parent.purpose == "benefit" %} ğŸ å„ªå¾…
        {% else %} {{ parent.purpose }}
        {% endif %}
      </div>
        {% endif %}



      <div class="trade-actions">
        <button class="action-btn buy open-modal"
          data-id="{{ parent.id }}" data-type="buy"
          data-stock="{{ parent.stock }}" data-price="{{ parent.price }}"
          data-quantity="{{ parent.quantity }}">ï¼‹è²·ã„</button>
        <button class="action-btn sell open-modal"
          data-id="{{ parent.id }}" data-type="sell"
          data-stock="{{ parent.stock }}" data-price="{{ parent.price }}"
          data-quantity="{{ parent.quantity }}">âˆ’å£²ã‚Š</button>
          <a href="#" class="edit-link"
            data-id="{{ parent.id }}"
            data-type="{{ parent.type }}"
            data-stock="{{ parent.stock }}"
            data-code="{{ parent.code }}"
            data-price="{{ parent.price }}"
            data-quantity="{{ parent.quantity }}"
            data-total="{{ parent.total }}"
            data-date="{{ parent.date }}"
            data-feeling="{{ parent.feeling }}"
            data-purpose="{{ parent.purpose }}"
            data-memo="{{ parent.memo }}"
          >ç·¨é›†</a>
        <a href="/delete/{{ parent.id }}" class="delete-link">å‰Šé™¤</a>
      </div>

      <!-- å­ã‚«ãƒ¼ãƒ‰ãŸã¡ -->
      <div class="child-cards">
        {% for child in children %}
          {% set child_label = (
            'è²·ã„å¢—ã—' if parent.type == 'buy' and child.type == 'buy' else
            'å£²å´'     if parent.type == 'buy' and child.type == 'sell' else
            'å£²ã‚Šå¢—ã—' if parent.type == 'sell' and child.type == 'sell' else
            'è²·ã„æˆ»ã—' if parent.type == 'sell' and child.type == 'buy' else
            'å–å¼•'
          ) %}
          <div class="trade-card child">
            <div class="trade-row">
              <strong>â”” ğŸ’¸ {{ child_label }}:</strong> {{ child.quantity }}æ ª @ {{ child.price }}å††
            </div>
            <div class="trade-row"><strong>æ—¥ä»˜:</strong> {{ child.date }}</div>
            <div class="trade-row"><strong>æ„Ÿæƒ…:</strong>
              <span class="feeling-{{ child.feeling }}">
                {{ ['','ğŸ˜– ãƒã‚¬ãƒ†ã‚£ãƒ–','ğŸ˜ ã‚„ã‚„ä¸å®‰','ğŸ˜ ãµã¤ã†','ğŸ™‚ ã¾ã‚ã¾ã‚','ğŸ˜„ ãƒãƒƒãƒ”ãƒ¼'][child.feeling] }}
              </span>
            </div>
            {% if child.profit is defined and child.profit is not none %}
              <div class="trade-row">
                <strong>ğŸ“ˆ åˆ©ç›Š:</strong> {{ child.profit | round(2) }} å††
              </div>
            {% endif %}
            {% if child.memo %}
              <div class="trade-row"><strong>ãƒ¡ãƒ¢:</strong> {{ child.memo }}</div>
            {% endif %}
            <div class="trade-actions">
              <a href="/form?edit_id={{ child.id }}" class="edit-link">ç·¨é›†</a>
              <a href="/delete/{{ child.id }}">å‰Šé™¤</a>
            </div>
          </div>
        {% endfor %}
      </div>
      <!-- /child-cards -->
    </div>
  {% endfor %}
</div>


<!-- âœ… ã‚¦ã‚©ãƒƒãƒå‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="watch-delete-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.6); z-index:1000;">
  <div style="background:#fff; padding:20px; margin:15% auto; width:300px; border-radius:8px; text-align:center;">
    <p>ã“ã®éŠ˜æŸ„ã¯ã‚¦ã‚©ãƒƒãƒä¸­ã§ã™ã€‚<br>ä¸Šæ›¸ãã—ã¦ã‚¦ã‚©ãƒƒãƒä¸­ã®éŠ˜æŸ„ã‚’ä¸€è¦§ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</p>
    <button id="watch-confirm-delete" style="margin:10px;">ã¯ã„</button>
    <button id="watch-cancel" style="margin:10px;">ã„ã„ãˆ</button>
  </div>
</div>





<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆåå¯¾å£²è²·å…¥åŠ›ï¼‰ -->
<div id="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.6); z-index:999;">
  <div style="background:#fff; padding:20px; margin:10% auto; width:300px; position:relative;">
    <h3 id="modal-title">åå¯¾å£²è²·</h3>
    <form method="POST" action="/form">
      <input type="hidden" name="parent_id" id="modal-parent-id">
      <input type="hidden" name="type" id="modal-type">
<div>
  <label>éŠ˜æŸ„åï¼š<input type="text" name="stock" id="modal-stock" required></label>
</div>
<div>
  <label>æ ªä¾¡ï¼š<input type="number" name="price" id="modal-price" required></label>
</div>
<div>
  <label>æ•°é‡ï¼š<input type="number" name="quantity" id="modal-quantity" required></label>
</div>
      <div>
        <div>
        <label>æ—¥ä»˜ï¼š<input type="date" name="date" required></label>
      </div>
        <label>æ„Ÿæƒ…ï¼š
          <select name="feeling">
            <option value="0">æœªè¨­å®š</option>
            <option value="1">ğŸ˜–</option>
            <option value="2">ğŸ˜</option>
            <option value="3">ğŸ˜</option>
            <option value="4">ğŸ™‚</option>
            <option value="5">ğŸ˜„</option>
          </select>
        </label>
      </div>
      <div>
        <label>ãƒ¡ãƒ¢ï¼š<textarea name="memo"></textarea></label>
      </div>
      <button type="submit">ç™»éŒ²</button>
      <button type="button" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </form>
  </div>
</div>


<!-- ã“ã‚Œã‚’history.htmlã®æœ«å°¾ã€</div>ã®ç›´å‰ã‚„bodyçµ‚äº†ç›´å‰ã‚ãŸã‚Šã«è¿½åŠ  -->
<div id="edit-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.6); z-index:1001;">
  <div style="background:#fff; padding:20px; margin:5% auto; width:320px; border-radius:8px; text-align:center;">
    <h3>å–å¼•å†…å®¹ã‚’ç·¨é›†</h3>
    <form id="edit-form" method="POST" action="/form">
      <input type="hidden" name="edit_id" id="edit-id">
      <label>ç¨®åˆ¥ï¼š<input type="text" name="type" id="edit-type"></label><br>
      <label>éŠ˜æŸ„åï¼š<input type="text" name="stock" id="edit-stock"></label><br>
      <label>ã‚³ãƒ¼ãƒ‰ï¼š<input type="text" name="code" id="edit-code"></label><br>
      <label>æ ªä¾¡ï¼š<input type="number" step="0.01" name="price" id="edit-price"></label><br>
      <label>æ•°é‡ï¼š<input type="number" name="quantity" id="edit-quantity"></label><br>
      <label>å–å¼•é¡ï¼š<input type="number" step="0.01" name="total" id="edit-total"></label><br>
      <label>æ—¥ä»˜ï¼š<input type="date" name="date" id="edit-date"></label><br>
      <label>æ„Ÿæƒ…ï¼š<input type="number" name="feeling" id="edit-feeling" min="1" max="5"></label><br>
      <label>ç›®çš„ï¼š<input type="text" name="purpose" id="edit-purpose"></label><br>
      <label>ãƒ¡ãƒ¢ï¼š<textarea name="memo" id="edit-memo"></textarea></label><br>
      <button type="submit">ä¿å­˜</button>
      <button type="button" onclick="closeEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </form>
  </div>
</div>


<script>
function openModal(parentId, typeLabel, stock, price, quantity) {
  document.getElementById("modal").style.display = "block";
  document.getElementById("modal-parent-id").value = parentId;
  document.getElementById("modal-type").value = (typeLabel === 'è²·ã„') ? 'buy' : 'sell';
  document.getElementById("modal-title").innerText = typeLabel;

  // è‡ªå‹•è£œå®Œ
  document.getElementById("modal-stock").value = stock;
  document.getElementById("modal-price").value = price;
  document.getElementById("modal-quantity").value = quantity;

  const today = new Date().toISOString().split('T')[0];
  document.querySelector('#modal input[name="date"]').value = today;
}

function closeModal() {
  document.getElementById("modal").style.display = "none";
}
</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.open-modal').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        const type = btn.dataset.type;
        const stock = btn.dataset.stock;
        const price = btn.dataset.price;
        const quantity = btn.dataset.quantity;

        document.getElementById("modal").style.display = "block";
        document.getElementById("modal-parent-id").value = id;
        document.getElementById("modal-type").value = type;
        document.getElementById("modal-title").innerText = type === "buy" ? "è²·ã„" : "å£²ã‚Š";

        document.getElementById("modal-stock").value = stock;
        document.getElementById("modal-price").value = price;
        document.getElementById("modal-quantity").value = quantity;

        const today = new Date().toISOString().split('T')[0];
        document.querySelector('#modal input[name="date"]').value = today;
      });
    });

  });
</script>

<script>
function closeModal() {
  document.getElementById("modal").style.display = "none";
}

function showWatchDeleteModal(watchId) {
  const modal = document.getElementById("watch-delete-modal");
  modal.style.display = "block";

  document.getElementById("watch-confirm-delete").onclick = () => {
    window.location.href = '/delete/' + watchId;
  };
  document.getElementById("watch-cancel").onclick = () => {
    modal.style.display = "none";
  };
}
</script>

<script>
  // Pythonå´ã‹ã‚‰æ¸¡ã•ã‚ŒãŸå€¤ã‚’JSå¤‰æ•°ã¨ã—ã¦å—ã‘å–ã‚‹
  const watchToDelete = {{ watch_to_delete | tojson }};
  document.addEventListener("DOMContentLoaded", () => {
    if (watchToDelete) {
      showWatchDeleteModal(watchToDelete);
    }
  });
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.edit-link').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      // dataå±æ€§ã‹ã‚‰å€¤ã‚’ã‚»ãƒƒãƒˆ
      document.getElementById('edit-id').value = btn.dataset.id || '';
      document.getElementById('edit-type').value = btn.dataset.type || '';
      document.getElementById('edit-stock').value = btn.dataset.stock || '';
      document.getElementById('edit-code').value = btn.dataset.code || '';
      document.getElementById('edit-price').value = btn.dataset.price || '';
      document.getElementById('edit-quantity').value = btn.dataset.quantity || '';
      document.getElementById('edit-total').value = btn.dataset.total || '';
      document.getElementById('edit-date').value = btn.dataset.date || '';
      document.getElementById('edit-feeling').value = btn.dataset.feeling || '';
      document.getElementById('edit-purpose').value = btn.dataset.purpose || '';
      document.getElementById('edit-memo').value = btn.dataset.memo || '';
      document.getElementById('edit-modal').style.display = "block";
    });
  });
});

function closeEditModal() {
  document.getElementById('edit-modal').style.display = "none";
}
</script>






{% endblock %}