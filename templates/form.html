<!-- templates/form.html -->

{% extends "layout.html" %}
{% block title %}æŠ•è³‡è¨˜éŒ²ã®å…¥åŠ›{% endblock %}
{% block content %}


<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚³ã‚³ãƒˆã‚· - æŠ•è³‡è¨˜éŒ²</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

{% if error_msg %}
  <div class="error-msg" style="color:red; font-weight:bold;">{{ error_msg }}</div>
{% endif %}



<body>
  <h2>ğŸ“ æŠ•è³‡è¨˜éŒ²ã®å…¥åŠ›</h2>
  
<form method="POST">

  <label>ç¨®åˆ¥ï¼š
    <select name="type" required>
      <option value="buy"   {% if type == "buy" %}selected{% endif %}>è²·ã„</option>
      <option value="sell"  {% if type == "sell" %}selected{% endif %}>å£²ã‚Š</option>
      <option value="watch" {% if type == "watch" %}selected{% endif %}>ã‚¦ã‚©ãƒƒãƒ</option>
    </select>
  </label>

  <label>éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ï¼ˆ4æ¡ or ãƒ†ã‚£ãƒƒã‚«ãƒ¼ï¼‰ï¼š
    <input type="text" id="code" name="code" maxlength="10"
      value="{{ code or '' }}" oninput="fetchCompanyName()" required />
  </label>

  <label>éŠ˜æŸ„åï¼ˆè‡ªå‹•åæ˜ ãƒ»æ—¥æœ¬æ ªã®ã¿ï¼‰ï¼š
    <input type="text" id="company" name="stock" value="{{ stock or '' }}" readonly required />
  </label>

  <label>æ ªä¾¡ï¼ˆå††ï¼‰ï¼š
    <input type="text" name="price" value="{{ price or '' }}" required>
  </label>

  <label>æ•°é‡ï¼š
    <input type="text" name="quantity" value="{{ request.form.quantity or quantity or 100 }}" required>

  </label>

  <label>å–å¼•é¡ï¼ˆå††ï¼‰ï¼š
    <input type="text" name="total" id="total" value="{{ total or '' }}" readonly style="background:#eee; color:#888;">
  </label>

  <label>æ—¥ä»˜ï¼š
    <input type="date" name="date" id="date" value="{{ date or today }}">
  </label>

  <label>æ„Ÿæƒ…ï¼š</label>
  <div class="feeling-options">
    {% for feeling in entry_feelings %}
      <label>
        <input type="radio" name="feeling" value="{{ loop.index0 }}"
          {% if (feeling is defined and (feeling|string) == (loop.index0|string)) or (feeling is not defined and loop.index0 == 2) %}checked{% endif %}
          required>
        <span class="feeling-label feeling-{{ loop.index0 }}">{{ feeling }}</span>
      </label>
    {% endfor %}
  </div>

  <label>æŠ•è³‡ç›®çš„ï¼š</label>
  <div class="purpose-options">
    <label>
      <input type="radio" class="purpose-radio" name="purpose" value="0"
        {% if purpose is defined and (purpose|string) == "0" %}checked{% endif %}>
      <span class="purpose-icon">
        <img src="{{ url_for('static', filename='icons/short.svg') }}" alt="çŸ­æœŸ" width="28" height="28">
      </span>
      <span class="purpose-label">çŸ­æœŸ</span>
    </label>
    <label>
      <input type="radio" class="purpose-radio" name="purpose" value="1"
        {% if purpose is defined and (purpose|string) == "1" %}checked{% endif %}>
      <span class="purpose-icon">
        <img src="{{ url_for('static', filename='icons/middle.svg') }}" alt="ä¸­æœŸ" width="28" height="28">
      </span>
      <span class="purpose-label">ä¸­æœŸ</span>
    </label>
    <label>
      <input type="radio" class="purpose-radio" name="purpose" value="2"
        {% if purpose is defined and (purpose|string) == "2" %}checked{% endif %}>
      <span class="purpose-icon">
        <img src="{{ url_for('static', filename='icons/long.svg') }}" alt="é•·æœŸ" width="28" height="28">
      </span>
      <span class="purpose-label">é•·æœŸ</span>
    </label>
    <label>
      <input type="radio" class="purpose-radio" name="purpose" value="3"
        {% if purpose is defined and (purpose|string) == "3" %}checked{% endif %}>
      <span class="purpose-icon">
        <img src="{{ url_for('static', filename='icons/benefits.svg') }}" alt="å„ªå¾…" width="28" height="28">
      </span>
      <span class="purpose-label">å„ªå¾…</span>
    </label>
    <label>
      <input type="radio" class="purpose-radio" name="purpose" value="4"
        {% if purpose is defined and (purpose|string) == "4" %}checked{% endif %}>
      <span class="purpose-icon">
        <img src="{{ url_for('static', filename='icons/dividend.svg') }}" alt="é…å½“" width="28" height="28">
      </span>
      <span class="purpose-label">é…å½“</span>
    </label>
  </div>

  <label>ãƒ¡ãƒ¢ï¼š
    <textarea name="memo" rows="3">{{ memo or '' }}</textarea>
  </label>

  <button class="btn" type="submit">ä¿å­˜ã™ã‚‹</button>
</form>


<!-- ã“ã“ã‹ã‚‰é‡è¤‡ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
{% if duplicate_type == "same-purpose" %}
  <div class="modal-overlay">
    <div class="modal-box">
      <div style="margin-bottom:16px;">
        <b>ã™ã§ã«åŒç›®çš„ã®åŒéŠ˜æŸ„ã‚’æ‰€æœ‰ä¸­ã§ã™ã€‚åˆç®—ã—ã¾ã™ã‹ï¼Ÿ</b>
      </div>
      <form method="POST">
        <!-- ç™»éŒ²æƒ…å ±ã‚’hiddenã§å…¨ã¦å†é€ä¿¡ -->
        <input type="hidden" name="type" value="{{ type or '' }}">
        <input type="hidden" name="code" value="{{ code or '' }}">
        <input type="hidden" name="stock" value="{{ stock or '' }}">
        <input type="hidden" name="price" value="{{ price or '' }}">
        <input type="hidden" name="quantity" value="{{ quantity or '' }}">
        <input type="hidden" name="total" value="{{ total or '' }}">
        <input type="hidden" name="date" value="{{ date or today }}">
        <input type="hidden" name="feeling" value="{{ feeling or '' }}">
        <input type="hidden" name="purpose" value="{{ purpose or '' }}">
        <input type="hidden" name="memo" value="{{ memo or '' }}">
        <input type="hidden" name="confirm" value="åˆç®—">
        <button class="btn" type="submit">åˆç®—ã™ã‚‹</button>
        <a href="{{ url_for('form') }}" class="btn btn-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
      </form>
    </div>
  </div>
{% elif duplicate_type == "diff-purpose" %}
  <div class="modal-overlay">
    <div class="modal-box">
      <div style="margin-bottom:16px;">
        <b>åŒéŠ˜æŸ„ã‚’æ‰€æœ‰ä¸­ã§ã™ãŒã€ç›®çš„ãŒç•°ãªã‚‹ãŸã‚æ–°ãŸã«è¦ªã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</b>
      </div>
      <form method="POST">
        <input type="hidden" name="type" value="{{ type or '' }}">
        <input type="hidden" name="code" value="{{ code or '' }}">
        <input type="hidden" name="stock" value="{{ stock or '' }}">
        <input type="hidden" name="price" value="{{ price or '' }}">
        <input type="hidden" name="quantity" value="{{ quantity or '' }}">
        <input type="hidden" name="total" value="{{ total or '' }}">
        <input type="hidden" name="date" value="{{ date or today }}">
        <input type="hidden" name="feeling" value="{{ feeling or '' }}">
        <input type="hidden" name="purpose" value="{{ purpose or '' }}">
        <input type="hidden" name="memo" value="{{ memo or '' }}">
        <input type="hidden" name="confirm" value="æ–°è¦">
        <button class="btn" type="submit">æ–°è¦ã§ç™»éŒ²</button>
        <a href="{{ url_for('form') }}" class="btn btn-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
      </form>
    </div>
  </div>
{% endif %}




  </form>


<style>
.modal-overlay {
  position: fixed; left:0; top:0; width:100vw; height:100vh;
  background: rgba(0,0,0,0.18); z-index:10000;
  display: flex; align-items: center; justify-content: center;
}
.modal-box {
  background: #fff; padding: 32px 24px 24px 24px;
  border-radius: 16px; box-shadow: 0 6px 24px #0002;
  min-width: 270px; max-width: 92vw;
  text-align: center;
}
.btn-cancel {
  background: #bbb; color: #fff; margin-left: 20px;
  border-radius: 12px; padding: 8px 18px;
  text-decoration: none;
}
</style>

  <div style="height:90px;"></div>







<script>
  document.addEventListener("DOMContentLoaded", () => {
    const priceInput = document.querySelector('input[name="price"]');
    const quantityInput = document.querySelector('input[name="quantity"]');
    const totalInput = document.querySelector('input[name="total"]');
    const dateInput = document.querySelector('input[name="date"]');

    // åˆè¨ˆé‡‘é¡ï¼ˆã‚«ãƒ³ãƒä»˜ï¼‰è‡ªå‹•è¨ˆç®—
    function updateTotal() {
      const price = parseFloat(priceInput.value.replace(/,/g, "")) || 0;
      const quantity = parseInt(quantityInput.value.replace(/,/g, "")) || 0;
      const total = price * quantity;
      totalInput.value = total ? Math.round(total).toLocaleString() : "";
    }

    priceInput.addEventListener("input", updateTotal);
    quantityInput.addEventListener("input", updateTotal);

    // ãƒ•ã‚©ãƒ¼ãƒ åˆæœŸè¡¨ç¤ºæ™‚ã‚‚åˆè¨ˆé‡‘é¡ã‚’è¡¨ç¤º
    updateTotal();

    // ä»Šæ—¥ã®æ—¥ä»˜ã‚’è‡ªå‹•ã‚»ãƒƒãƒˆï¼ˆæœªå…¥åŠ›æ™‚ã®ã¿ï¼‰
    if (dateInput && !dateInput.value) {
      const today = new Date().toISOString().split("T")[0];
      dateInput.value = today;
    }
  });


function fetchCompanyName() {
    const code = document.getElementById('code').value.padStart(4, '0');
    if (!code) {
        document.getElementById('company').value = '';
        return;
    }
    fetch(`/api/company_name?code=${code}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('company').value = data.company || '';
        })
        .catch(() => {
            document.getElementById('company').value = '';
        });
}


  // æ—¢å­˜ã®DOMContentLoadedå†…ã®ä¸‹ã«è¿½è¨˜ã§ã‚‚OK
  document.addEventListener("DOMContentLoaded", () => {
    // ...æ—¢å­˜ã®updateTotalãªã©...

    // â˜…ã“ã“ã‹ã‚‰ä¼šç¤¾åè‡ªå‹•è£œå®Œ
    const codeInput = document.getElementById('stock_code');
    const nameInput = document.getElementById('company_name');

    if (codeInput && nameInput) {
      codeInput.addEventListener('blur', function() {
        const code = this.value.padStart(4, '0');
        if (!code.match(/^\d{4}$/)) {
          nameInput.value = '';
          return;
        }
        fetch(`/api/company_name?code=${code}`)
          .then(response => response.json())
          .then(data => {
            nameInput.value = data.company || '';
          })
          .catch(() => {
            nameInput.value = '';
          });
      });
    }
  });



</script>




</body>
</html>





{% endblock %}
