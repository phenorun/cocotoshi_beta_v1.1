{% extends "layout.html" %}
{% block content %}

<script>
  document.addEventListener('DOMContentLoaded', function() {
    document.body.classList.add('matrix-overflow-fix');
    let mc = document.querySelector('.main-content');
    if(mc) mc.classList.add('matrix-overflow-fix');
    let mp = document.querySelector('.matrix-page');
    if(mp) mp.classList.add('matrix-overflow-fix');
  });
</script>





<div class="matrix-page">

  <h2 style="margin-bottom:0;">ğŸ§  æ„Ÿæƒ… Ã— åˆ©ç›Šãƒãƒˆãƒªã‚¯ã‚¹</h2>

  <div class="matrix-tabs">
    <button class="tab-btn active" onclick="showTab('heatmap')">æ„Ÿæƒ…ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</button>
    <button class="tab-btn" onclick="showTab('purpose')">ç›®çš„Ã—æœŸé–“Ã—å‹ç‡</button>
    <button class="tab-btn" onclick="showTab('data')">ç”Ÿãƒ‡ãƒ¼ã‚¿</button>
  </div>

   <!-- æ„Ÿæƒ…ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ— -->

<div id="tab-heatmap" class="tab-content active">
  <div class="matrix-wrapper" style="overflow-x:auto;width:100vw;-webkit-overflow-scrolling:touch;">
    <table class="matrix-table">
      <thead>
        <tr>
          <th>Exitâ†’  â†“Entry</th>
          {% for label in exit_feelings %}
            <th>
              <span class="feeling-label feeling-{{ loop.index0 }}">{{ label }}</span>
            </th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for i in range(heatmap|length) %}
          <tr>
            <th>
              <span class="feeling-label feeling-{{ i }}">{{ entry_feelings[i] }}</span>
            </th>
            {% for j in range(heatmap[i]|length) %}
              <td class="
                heat 
                {% if heatmap[i][j] > 0 %}positive
                {% elif heatmap[i][j] < 0 %}negative
                {% else %}neutral{% endif %}
              ">
                {{ heatmap[i][j] }}
                {% if heatmap_counts[i][j] > 0 %}
                  <span class="badge">{{ heatmap_counts[i][j] }}ä»¶</span>
                {% endif %}
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>




<!-- æœŸé–“å‹ç‡ã‚°ãƒ©ãƒ• -->
<!-- Chart.jsã®CDNã¯<head>å†… or ã“ã“ã§ä¸€åº¦ã ã‘èª­ã¿è¾¼ã¿ã§OKï¼ˆè¤‡æ•°å›ä¸è¦ï¼‰-->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<div id="tab-purpose" class="tab-content" style="display:none">
  <h3 style="margin-top:0;">ç›®çš„ Ã— ä¿æœ‰æœŸé–“ Ã— å‹ç‡</h3>
  <canvas id="purposeChart" style="max-width:720px; width:100%;"></canvas>
</div>
<script>
const purposeGraphData = {{ purpose_graph_data | tojson | safe }};
document.addEventListener('DOMContentLoaded', function() {
  if (!purposeGraphData || !purposeGraphData.length) return;
  const ctx = document.getElementById('purposeChart').getContext('2d');
  const labels = purposeGraphData.map(x => x.purpose);
  const avgDays = purposeGraphData.map(x => x.avg_days);
  const winRates = purposeGraphData.map(x => x.win_rate);

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          type: 'bar',
          label: 'å¹³å‡ä¿æœ‰æœŸé–“ï¼ˆæ—¥ï¼‰',
          data: avgDays,
          backgroundColor: '#0af',
          yAxisID: 'y-days',
          order: 1,
        },
        {
          type: 'line',
          label: 'å‹ç‡ï¼ˆ%ï¼‰',
          data: winRates,
          borderColor: '#e91e63',
          backgroundColor: '#e91e63',
          yAxisID: 'y-win',
          tension: 0.25,
          pointRadius: 4,
          fill: false,
          order: 2,
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: true,
          position: 'top',
        },
        tooltip: { enabled: true }
      },
      scales: {
        x: { title: { display: true, text: 'æŠ•è³‡ç›®çš„' } },
        'y-days': {
          position: 'left',
          title: { display: true, text: 'å¹³å‡ä¿æœ‰æœŸé–“ï¼ˆæ—¥ï¼‰' },
          beginAtZero: true,
        },
        'y-win': {
          position: 'right',
          title: { display: true, text: 'å‹ç‡ï¼ˆ%ï¼‰' },
          beginAtZero: true,
          max: 100,
          grid: { drawOnChartArea: false },
        }
      }
    }
  });
});
</script>







</div>






   <!-- ç”Ÿãƒ‡ãƒ¼ã‚¿ -->


<div id="tab-data" class="tab-content" style="display:none">
  

<div style="display: flex; gap: 8px; align-items: center; margin-bottom: 1em;">
  <form method="get" style="display:inline;">
    <input type="hidden" name="sort" value="date_desc">
    <button type="submit" {% if sort == "date_desc" %}disabled{% endif %}>æ—¥ä»˜ã®æ–°ã—ã„é †</button>
  </form>
  <form method="get" style="display:inline;">
    <input type="hidden" name="sort" value="date_asc">
    <button type="submit" {% if sort == "date_asc" %}disabled{% endif %}>æ—¥ä»˜ã®å¤ã„é †</button>
  </form>
  <form method="get" style="display:inline;">
    <input type="hidden" name="sort" value="profit_desc">
    <button type="submit" {% if sort == "profit_desc" %}disabled{% endif %}>åˆ©ç›ŠãŒå¤§ãã„é †</button>
  </form>
  <form method="get" style="display:inline;">
    <input type="hidden" name="sort" value="profit_asc">
    <button type="submit" {% if sort == "profit_asc" %}disabled{% endif %}>æå¤±ãŒå¤§ãã„é †</button>
  </form>
</div>


  <!-- æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆãã®ã¾ã¾ï¼‰ -->
  <div style="width:100%; max-width:1200px; margin:0 auto 1em auto; display:flex; justify-content:flex-end;">
    <form method="get" action="/matrix" style="display:flex; gap:4px; align-items:center;">
      <input type="text" name="q" placeholder="æ¤œç´¢" value="{{ request.args.get('q', '') }}" style="width: 140px;">
      <button type="submit">æ¤œç´¢</button>
      <button type="button" id="clear-btn">ã‚¯ãƒªã‚¢</button>
    </form>
  </div>

  <div class="trade-list">


{% for row in results %}
<div class="trade-card">
  <div class="trade-row">
    <span class="stock-name">{{ row[7] or 'ï¼ˆéŠ˜æŸ„åï¼‰' }}</span>
    <span class="trade-date">{{ row[8] }}</span>
    <span class="trade-profit {% if row[0]|int > 0 %}profit{% else %}loss{% endif %}">{{ "{:+,}".format(row[0]|int) }}å††</span>
  </div>
<div class="trade-info-row">
{% set entry_index = row[1] if row[1] >= 0 and row[1] < entry_feelings|length else 0 %}
{% set exit_index = row[2] if row[2] >= 0 and row[2] < exit_feelings|length else 0 %}
<span class="feeling-icon entry">{{ entry_feelings[entry_index] }}</span>
<span class="arrow">â‡’</span>
<span class="feeling-icon exit">{{ exit_feelings[exit_index] }}</span>


<span class="purpose-label" style="display: inline-flex; align-items: center; gap: 4px;">
{% set pid = row[9]|int %}
{% if pid == 0 %}
  <span class="purpose-icon">ğŸ’¹</span>çŸ­æœŸ
{% elif pid == 1 %}
  <span class="purpose-icon">ğŸ“Š</span>ä¸­æœŸ
{% elif pid == 2 %}
  <span class="purpose-icon">ğŸ“ˆ</span>é•·æœŸ
{% elif pid == 3 %}
  <span class="purpose-icon">ğŸ</span>å„ªå¾…
{% elif pid == 4 %}
  <span class="purpose-icon">ğŸ’°</span>é…å½“
{% else %}
  â€•
{% endif %}
</span>

  <span class="memo-toggle" onclick="toggleMemo(this, event)">ãƒ¡ãƒ¢â–¼</span>
  <a href="/history?id={{ row[6] }}" class="history-link">è©³ç´°</a>
</div>

  <div class="trade-memo" style="display:none;">
    <span class="memo-entry"><b>ã‚¨ãƒ³ãƒˆãƒªãƒ¼</b>: {{ row[4] }}</span>
    <span class="memo-exit"><b>æ±ºæ¸ˆ</b>: {{ row[5] }}</span>
  </div>
</div>




{% endfor %}




  </div>

  <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãã®ã¾ã¾ï¼‰ -->
  <div class="pagination" style="text-align:center; margin: 16px 0;">
    {% if page > 1 %}
      <a href="?page={{ page - 1 }}">Â« å‰ã¸</a>
    {% endif %}
    <span style="margin:0 8px;">{{ page }} / {{ total_pages }}</span>
    {% if page < total_pages %}
      <a href="?page={{ page + 1 }}">æ¬¡ã¸ Â»</a>
    {% endif %}
  </div>
</div>







</div>



<style>
.matrix-tabs { display:flex; gap:1em; margin-bottom:1em; }
.tab-btn {
  font-size:1em; padding:0.5em 1.5em; border-radius:7px;
  background:#e8eaf1; border:none; font-weight:bold; color:#235;
  cursor:pointer; box-shadow:0 2px 5px #f0f2ff;
}
.tab-btn.active { background:#0af; color:#fff; }
.tab-content { background:#fff; border-radius:10px; min-height:0; box-shadow:0 1px 8px #eee; padding:1.1em;}

</style>
<script>
function showTab(tab) {
  ['heatmap','purpose','data'].forEach(id => {
    const el = document.getElementById('tab-' + id);
    if (el) {
      el.style.display = (id === tab) ? 'block' : 'none';
    }
    const btn = document.querySelector('.tab-btn[onclick*="'+id+'"]');
    if (btn) btn.classList.toggle('active', id === tab);
  });
}

</script>





<script>
function toggleMatrixMemo(button, baseId) {
  const shortText = document.getElementById(baseId);
  const fullDiv = document.getElementById(baseId + "-full");
  const openBtn = document.getElementById("memo-toggle-" + baseId);
  const closeBtn = document.getElementById("memo-toggle-close-" + baseId);

  if (fullDiv.style.display === "none" || !fullDiv.style.display) {
    // å…¨æ–‡è¡¨ç¤º
    if (shortText) shortText.style.display = "none";
    if (openBtn) openBtn.style.display = "none";
    if (fullDiv) fullDiv.style.display = "flex";
    if (closeBtn) closeBtn.style.display = "inline-block";
  } else {
    // æŠ˜ã‚Šç•³ã¿è¡¨ç¤º
    if (shortText) shortText.style.display = "";
    if (openBtn) openBtn.style.display = "inline-block";
    if (fullDiv) fullDiv.style.display = "none";
    if (closeBtn) closeBtn.style.display = "none";
  }
}




var clearBtn = document.getElementById('clear-btn');
if (clearBtn) {
  clearBtn.onclick = function() {
    window.location.href = '/matrix';
  };
}



</script>

<script>
function toggleDetail(card) {
  const detail = card.querySelector('.trade-detail');
  const toggle = card.querySelector('.expand-toggle');
  if (!detail || !toggle) return;
  if (detail.style.display === "none" || !detail.style.display) {
    detail.style.display = "block";
    toggle.textContent = "â–²";
  } else {
    detail.style.display = "none";
    toggle.textContent = "â–¼";
  }
}

function toggleMemo(el, event) {
  event.stopPropagation();
  const memo = el.closest('.trade-card').querySelector('.trade-memo');
  if (memo.style.display === 'none' || !memo.style.display) {
    memo.style.display = 'block';
    el.textContent = 'ãƒ¡ãƒ¢åç´â–²';
  } else {
    memo.style.display = 'none';
    el.textContent = 'ãƒ¡ãƒ¢å±•é–‹â–¼';
  }
}





</script>






</body>






{% endblock %}
