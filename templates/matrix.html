{% extends "layout.html" %}
{% block content %}

<script>
  document.addEventListener('DOMContentLoaded', function() {
    document.body.classList.add('matrix-overflow-fix');
    let mc = document.querySelector('.main-content');
    if(mc) mc.classList.add('matrix-overflow-fix');
    let mp = document.querySelector('.matrix-page');
    if(mp) mp.classList.add('matrix-overflow-fix');
  });
</script>





<div class="matrix-page">

  <h2 style="margin-bottom:0;">🧠 感情 × 利益マトリクス</h2>

  <div class="matrix-tabs">
    <button class="tab-btn active" onclick="showTab('heatmap')">感情ヒートマップ</button>
    <button class="tab-btn" onclick="showTab('purpose')">目的×期間×勝率</button>
    <button class="tab-btn" onclick="showTab('data')">生データ</button>
  </div>

   <!-- 感情ヒートマップ -->

<div id="tab-heatmap" class="tab-content active">
  <div class="matrix-wrapper" style="overflow-x:auto;width:100vw;-webkit-overflow-scrolling:touch;">
    <table class="matrix-table">
      <thead>
        <tr>
          <th>Exit→  ↓Entry</th>
          {% for label in exit_feelings %}
            <th>
              <span class="feeling-label feeling-{{ loop.index0 }}">{{ label }}</span>
            </th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for i in range(heatmap|length) %}
          <tr>
            <th>
              <span class="feeling-label feeling-{{ i }}">{{ entry_feelings[i] }}</span>
            </th>
            {% for j in range(heatmap[i]|length) %}
              <td class="
                heat 
                {% if heatmap[i][j] > 0 %}positive
                {% elif heatmap[i][j] < 0 %}negative
                {% else %}neutral{% endif %}
              ">
                {{ heatmap[i][j] }}
                {% if heatmap_counts[i][j] > 0 %}
                  <span class="badge">{{ heatmap_counts[i][j] }}件</span>
                {% endif %}
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>




<!-- 期間勝率グラフ -->
<!-- Chart.jsのCDNは<head>内 or ここで一度だけ読み込みでOK（複数回不要）-->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<div id="tab-purpose" class="tab-content" style="display:none">
  <h3 style="margin-top:0;">目的 × 保有期間 × 勝率</h3>
  <canvas id="purposeChart" style="max-width:720px; width:100%;"></canvas>
</div>
<script>
const purposeGraphData = {{ purpose_graph_data | tojson | safe }};
document.addEventListener('DOMContentLoaded', function() {
  if (!purposeGraphData || !purposeGraphData.length) return;
  const ctx = document.getElementById('purposeChart').getContext('2d');
  const labels = purposeGraphData.map(x => x.purpose);
  const avgDays = purposeGraphData.map(x => x.avg_days);
  const winRates = purposeGraphData.map(x => x.win_rate);

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          type: 'bar',
          label: '平均保有期間（日）',
          data: avgDays,
          backgroundColor: '#0af',
          yAxisID: 'y-days',
          order: 1,
        },
        {
          type: 'line',
          label: '勝率（%）',
          data: winRates,
          borderColor: '#e91e63',
          backgroundColor: '#e91e63',
          yAxisID: 'y-win',
          tension: 0.25,
          pointRadius: 4,
          fill: false,
          order: 2,
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: true,
          position: 'top',
        },
        tooltip: { enabled: true }
      },
      scales: {
        x: { title: { display: true, text: '投資目的' } },
        'y-days': {
          position: 'left',
          title: { display: true, text: '平均保有期間（日）' },
          beginAtZero: true,
        },
        'y-win': {
          position: 'right',
          title: { display: true, text: '勝率（%）' },
          beginAtZero: true,
          max: 100,
          grid: { drawOnChartArea: false },
        }
      }
    }
  });
});
</script>







</div>






   <!-- 生データ -->


<div id="tab-data" class="tab-content" style="display:none">
  

<div style="display: flex; gap: 8px; align-items: center; margin-bottom: 1em;">
  <form method="get" style="display:inline;">
    <input type="hidden" name="sort" value="date_desc">
    <button type="submit" {% if sort == "date_desc" %}disabled{% endif %}>日付の新しい順</button>
  </form>
  <form method="get" style="display:inline;">
    <input type="hidden" name="sort" value="date_asc">
    <button type="submit" {% if sort == "date_asc" %}disabled{% endif %}>日付の古い順</button>
  </form>
  <form method="get" style="display:inline;">
    <input type="hidden" name="sort" value="profit_desc">
    <button type="submit" {% if sort == "profit_desc" %}disabled{% endif %}>利益が大きい順</button>
  </form>
  <form method="get" style="display:inline;">
    <input type="hidden" name="sort" value="profit_asc">
    <button type="submit" {% if sort == "profit_asc" %}disabled{% endif %}>損失が大きい順</button>
  </form>
</div>


  <!-- 検索フォーム（そのまま） -->
  <div style="width:100%; max-width:1200px; margin:0 auto 1em auto; display:flex; justify-content:flex-end;">
    <form method="get" action="/matrix" style="display:flex; gap:4px; align-items:center;">
      <input type="text" name="q" placeholder="検索" value="{{ request.args.get('q', '') }}" style="width: 140px;">
      <button type="submit">検索</button>
      <button type="button" id="clear-btn">クリア</button>
    </form>
  </div>

  <div class="trade-list">


{% for row in results %}
<div class="trade-card">
  <div class="trade-row">
    <span class="stock-name">{{ row[7] or '（銘柄名）' }}</span>
    <span class="trade-date">{{ row[8] }}</span>
    <span class="trade-profit {% if row[0]|int > 0 %}profit{% else %}loss{% endif %}">{{ "{:+,}".format(row[0]|int) }}円</span>
  </div>
<div class="trade-info-row">
{% set entry_index = row[1] if row[1] >= 0 and row[1] < entry_feelings|length else 0 %}
{% set exit_index = row[2] if row[2] >= 0 and row[2] < exit_feelings|length else 0 %}
<span class="feeling-icon entry">{{ entry_feelings[entry_index] }}</span>
<span class="arrow">⇒</span>
<span class="feeling-icon exit">{{ exit_feelings[exit_index] }}</span>


<span class="purpose-label" style="display: inline-flex; align-items: center; gap: 4px;">
{% set pid = row[9]|int %}
{% if pid == 0 %}
  <span class="purpose-icon">💹</span>短期
{% elif pid == 1 %}
  <span class="purpose-icon">📊</span>中期
{% elif pid == 2 %}
  <span class="purpose-icon">📈</span>長期
{% elif pid == 3 %}
  <span class="purpose-icon">🎁</span>優待
{% elif pid == 4 %}
  <span class="purpose-icon">💰</span>配当
{% else %}
  ―
{% endif %}
</span>

  <span class="memo-toggle" onclick="toggleMemo(this, event)">メモ▼</span>
  <a href="/history?id={{ row[6] }}" class="history-link">詳細</a>
</div>

  <div class="trade-memo" style="display:none;">
    <span class="memo-entry"><b>エントリー</b>: {{ row[4] }}</span>
    <span class="memo-exit"><b>決済</b>: {{ row[5] }}</span>
  </div>
</div>




{% endfor %}




  </div>

  <!-- ページネーション（そのまま） -->
  <div class="pagination" style="text-align:center; margin: 16px 0;">
    {% if page > 1 %}
      <a href="?page={{ page - 1 }}">« 前へ</a>
    {% endif %}
    <span style="margin:0 8px;">{{ page }} / {{ total_pages }}</span>
    {% if page < total_pages %}
      <a href="?page={{ page + 1 }}">次へ »</a>
    {% endif %}
  </div>
</div>







</div>



<style>
.matrix-tabs { display:flex; gap:1em; margin-bottom:1em; }
.tab-btn {
  font-size:1em; padding:0.5em 1.5em; border-radius:7px;
  background:#e8eaf1; border:none; font-weight:bold; color:#235;
  cursor:pointer; box-shadow:0 2px 5px #f0f2ff;
}
.tab-btn.active { background:#0af; color:#fff; }
.tab-content { background:#fff; border-radius:10px; min-height:0; box-shadow:0 1px 8px #eee; padding:1.1em;}

</style>
<script>
function showTab(tab) {
  ['heatmap','purpose','data'].forEach(id => {
    const el = document.getElementById('tab-' + id);
    if (el) {
      el.style.display = (id === tab) ? 'block' : 'none';
    }
    const btn = document.querySelector('.tab-btn[onclick*="'+id+'"]');
    if (btn) btn.classList.toggle('active', id === tab);
  });
}

</script>





<script>
function toggleMatrixMemo(button, baseId) {
  const shortText = document.getElementById(baseId);
  const fullDiv = document.getElementById(baseId + "-full");
  const openBtn = document.getElementById("memo-toggle-" + baseId);
  const closeBtn = document.getElementById("memo-toggle-close-" + baseId);

  if (fullDiv.style.display === "none" || !fullDiv.style.display) {
    // 全文表示
    if (shortText) shortText.style.display = "none";
    if (openBtn) openBtn.style.display = "none";
    if (fullDiv) fullDiv.style.display = "flex";
    if (closeBtn) closeBtn.style.display = "inline-block";
  } else {
    // 折り畳み表示
    if (shortText) shortText.style.display = "";
    if (openBtn) openBtn.style.display = "inline-block";
    if (fullDiv) fullDiv.style.display = "none";
    if (closeBtn) closeBtn.style.display = "none";
  }
}




var clearBtn = document.getElementById('clear-btn');
if (clearBtn) {
  clearBtn.onclick = function() {
    window.location.href = '/matrix';
  };
}



</script>

<script>
function toggleDetail(card) {
  const detail = card.querySelector('.trade-detail');
  const toggle = card.querySelector('.expand-toggle');
  if (!detail || !toggle) return;
  if (detail.style.display === "none" || !detail.style.display) {
    detail.style.display = "block";
    toggle.textContent = "▲";
  } else {
    detail.style.display = "none";
    toggle.textContent = "▼";
  }
}

function toggleMemo(el, event) {
  event.stopPropagation();
  const memo = el.closest('.trade-card').querySelector('.trade-memo');
  if (memo.style.display === 'none' || !memo.style.display) {
    memo.style.display = 'block';
    el.textContent = 'メモ収納▲';
  } else {
    memo.style.display = 'none';
    el.textContent = 'メモ展開▼';
  }
}





</script>






</body>






{% endblock %}
