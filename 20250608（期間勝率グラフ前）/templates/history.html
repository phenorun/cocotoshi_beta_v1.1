{% extends "layout.html" %}
{% block title %}å–å¼•å±¥æ­´ä¸€è¦§{% endblock %}
{% block content %}

<h1 style="text-align: center;">å–å¼•å±¥æ­´ä¸€è¦§</h1>

<div class="search-area-wrapper">
  <div class="left-column">
    <a href="/form" class="new-register-btn">ï¼‹æ–°è¦ç™»éŒ²</a>
  </div>
  <div class="right-column">
    <form method="get" action="/history" class="search-form">
      <input type="text" name="q" placeholder="æ¤œç´¢" value="{{ request.args.get('q', '') }}">
      <div class="search-buttons">
        <button type="submit">æ¤œç´¢</button>
        <button type="button" id="clear-button">ã‚¯ãƒªã‚¢</button>
      </div>
    </form>
  </div>
</div>



<div class="trade-list">
  {% for item in trade_tree %}
    {% set parent = item.parent %}
    {% set children = item.children %}
    {% set remaining = item.remaining %}
    {% set total_profit = item.total_profit %}


<!-- è¦ªã‚«ãƒ¼ãƒ‰ -->
<div class="trade-card parent{% if item.is_completed %} completed{% endif %}" data-trade-id="{{ parent.id }}">



  <div class="trade-type-label {{ parent.type }}">
    {{ 'ğŸ“¥ è²·ã„' if parent.type == 'buy' else 'ğŸ“¤ å£²ã‚Š' if parent.type == 'sell' else 'ğŸ‘€ ã‚¦ã‚©ãƒƒãƒ' }}
  </div>


  {% if item.is_completed %}
  <span class="soldout-label">å®Œå£²</span>
  {% endif %}




<div class="trade-row">
  <strong>éŠ˜æŸ„:</strong>
  <span class="stock-highlight">
    <span class="stock-name">{{ parent.stock }}</span>
    ï¼ˆ{{ parent.code }}ï¼‰
  </span>
</div>

  <div class="trade-row" style="display:flex; align-items:center;">
    {% if item.average_price is not none %}
      <span class="avg-label">ğŸ“Š å¹³å‡å–å¾—æ ªä¾¡:</span>
      <span class="avg-value">{{ "{:,}".format(item.average_price|int) }}å††</span>
    {% endif %}
    <span class="stock-remaining">æ®‹æ ªæ•°: {{ remaining }} æ ª</span>
  </div>

  <div class="trade-row"><strong>æ—¥ä»˜:</strong> {{ parent.date }}</div>
  <div class="trade-row">
    <strong>æ„Ÿæƒ…:</strong>
    <span class="feeling-label feeling-{{ parent.feeling }}">
      {{ entry_feelings[parent.feeling] }}
    </span>
  </div>


    <div class="trade-row">
    <strong>ğŸ’° åˆè¨ˆåˆ©ç›Š:</strong>
    <span class="{% if total_profit >= 0 %}profit-positive{% else %}profit-negative{% endif %}">
      {{ "{:,}".format(total_profit|int) }} å††
    </span>
   </div>


{% if parent.purpose %}
  {% set icon_list = ['ğŸ’¹', 'ğŸ“Š', 'ğŸ“ˆ', 'ğŸ', 'ğŸ’°'] %}
  {% set label_list = ['çŸ­æœŸ', 'ä¸­æœŸ', 'é•·æœŸ', 'å„ªå¾…', 'é…å½“'] %}
  <div class="trade-row" style="display:flex; align-items:center;">
    <strong style="margin-right:8px;">ç›®çš„:</strong>
    <span class="purpose-label" style="display:inline-flex; align-items:center; gap:4px;">
      {# æ•°å€¤ã‹ã©ã†ã‹åˆ¤å®šã—ã¦å‡¦ç†ã‚’åˆ†å² #}
      {% if parent.purpose in ['short', 'middle', 'long', 'benefit', 'dividend'] %}
        {% if parent.purpose == 'short' %}
          <span class="purpose-icon">ğŸ’¹</span>çŸ­æœŸ
        {% elif parent.purpose == 'middle' %}
          <span class="purpose-icon">ğŸ“Š</span>ä¸­æœŸ
        {% elif parent.purpose == 'long' %}
          <span class="purpose-icon">ğŸ“ˆ</span>é•·æœŸ
        {% elif parent.purpose == 'benefit' %}
          <span class="purpose-icon">ğŸ</span>å„ªå¾…
        {% elif parent.purpose == 'dividend' %}
          <span class="purpose-icon">ğŸ’°</span>é…å½“
        {% endif %}
      {% else %}
        {# æ•°å­—ã¨ã—ã¦æ‰±ã†ã€‚æ•°å­—ä»¥å¤–ãªã‚‰ãã®ã¾ã¾å‡ºã™ #}
        {% set idx = parent.purpose|int(default=-1) %}
        {% if 0 <= idx < 5 %}
          <span class="purpose-icon">{{ icon_list[idx] }}</span>{{ label_list[idx] }}
        {% else %}
          <span class="purpose-icon">â—†</span>{{ parent.purpose }}
        {% endif %}
      {% endif %}
    </span>
  </div>
{% endif %}



<div class="trade-row memo-row">
  <strong>ã‚³ãƒ¡ãƒ³ãƒˆ:</strong>
  <span class="memo-short">
    {{ parent.memo.splitlines()[0] if parent.memo else 'ï¼ˆãªã—ï¼‰' }}
    {% if parent.memo and (parent.memo.count('\n') > 0 or parent.memo|length > 32) %}
      <button class="memo-toggle" onclick="toggleMemo(this, 'parent-memo-{{ parent.id }}'); return false;">â–¼</button>
    {% endif %}
  </span>
</div>
<div class="memo-full" id="parent-memo-{{ parent.id }}" style="display:none;">
  {{ parent.memo|default('')|safe }}
</div>






  {# â–¼ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤ #}

      <div class="trade-actions">
        <button class="action-btn buy open-modal"
          data-id="{{ parent.id }}" data-type="buy"
           data-stock="{{ parent.stock }}" data-price="{{ parent.price }}"
         data-quantity="{{ parent.quantity }}"
          data-purpose="{{ parent.purpose }}">ï¼‹è²·ã„</button>
        <button class="action-btn sell open-modal"
          data-id="{{ parent.id }}" data-type="sell"
           data-stock="{{ parent.stock }}" data-price="{{ parent.price }}"
           data-quantity="{{ parent.quantity }}"
           data-purpose="{{ parent.purpose }}">âˆ’å£²ã‚Š</button>
          <a href="#" class="edit-link"
            data-id="{{ parent.id }}"
            data-type="{{ parent.type }}"
            data-stock="{{ parent.stock }}"
            data-code="{{ parent.code }}"
            data-price="{{ parent.price }}"
            data-quantity="{{ parent.quantity }}"
            data-total="{{ parent.total }}"
            data-date="{{ parent.date }}"
            data-feeling="{{ parent.feeling }}"
            data-purpose="{{ parent.purpose }}"
            data-memo="{{ parent.memo }}"
          >ç·¨é›†</a>
        <a href="#" class="delete-link" data-href="/delete/{{ parent.id }}">å‰Šé™¤</a>
      </div>
      
      {% if children|length > 0 %}
       <div class="has-children-badge">ï¼‹ è¿½åŠ å£²è²·å±¥æ­´ã‚ã‚Šï¼ˆã‚¿ãƒƒãƒ—ã§è¡¨ç¤ºï¼‰</div>
      {% endif %}




      <!-- å­ã‚«ãƒ¼ãƒ‰ãŸã¡ -->
  <div class="child-cards children-wrap{% if item.is_completed %} collapsed{% endif %}" data-trade-id="{{ parent.id }}">
    {% for child in children %}
      {% set child_label = (
        'è²·ã„å¢—ã—' if parent.type == 'buy' and child.type == 'buy' else
        'å£²å´'     if parent.type == 'buy' and child.type == 'sell' else
        'å£²ã‚Šå¢—ã—' if parent.type == 'sell' and child.type == 'sell' else
        'è²·ã„æˆ»ã—' if parent.type == 'sell' and child.type == 'buy' else
        'å–å¼•'
      ) %}

    <div class="trade-card child{% if item.is_completed %} completed{% endif %}">
      <div class="trade-row" style="display:flex; align-items:center;">
        {# 2åˆ†å²ã ã‘ï¼šbuyã¯é’ã€sellã¯èµ¤ #}
        <span class="trade-type-label trade-type-{{ child.type }}">
          {{ child_label }}
        </span>
        <span style="margin-left:12px;">
          {{ child.quantity }}æ ª @ {{ child.price|int }}å††
        </span>
      </div>

      <div class="trade-children{% if item.is_completed %} collapsed{% endif %}">
      </div>




        <div class="trade-row"><strong>æ—¥ä»˜:</strong> {{ child.date }}</div>
        <div class="trade-row"><strong>æ„Ÿæƒ…:</strong>
          {% if child.type in ['sell', 'buyback'] and parent.type in ['buy', 'sell'] %}
          <span class="feeling-label feeling-{{ child.feeling }}">
            {{ exit_feelings[child.feeling] }}
          </span>
          {% endif %}
        </div>



        {% if child.profits is defined and child.profits|length > 0 %}
         {% for profit in child.profits %}
         <div class="trade-row">
           <strong>ğŸ“ˆ åˆ©ç›Š:</strong>
           <span class="{% if profit >= 0 %}profit-positive{% else %}profit-negative{% endif %}">
             {{ "{:,}".format(profit|int) }} å††
           </span>
             </div>
          {% endfor %}
          {% endif %}

        <div class="trade-row memo-row">
        <strong>ã‚³ãƒ¡ãƒ³ãƒˆ:</strong>
        <span class="memo-short">
        {{ child.memo.splitlines()[0] if child.memo else 'ï¼ˆãªã—ï¼‰' }}
        {% if child.memo and (child.memo.count('\n') > 0 or child.memo|length > 32) %}
            <button class="memo-toggle" onclick="toggleMemo(event, this, 'child-memo-{{ child.id }}'); return false;">â–¼</button>
        {% endif %}
        </span>
        </div>
        <div class="memo-full" id="child-memo-{{ child.id }}" style="display:none;">
        {{ child.memo|default('')|safe }}
        </div>




            <div class="trade-actions">
              <a href="#" class="edit-link"
                  data-id="{{ child.id }}"
                   data-type="{{ child.type }}"
                 data-stock="{{ child.stock }}"
                  data-code="{{ child.code }}"
                  data-price="{{ child.price }}"
                  data-quantity="{{ child.quantity }}"
                  data-total="{{ child.total }}"
                  data-date="{{ child.date }}"
                  data-feeling="{{ child.feeling }}"
                  data-purpose="{{ child.purpose }}"
                  data-memo="{{ child.memo }}"
                  data-parent-id="{{ child.parent_id }}"
              >ç·¨é›†</a>

              <a href="#" class="delete-link" data-href="/delete/{{ child.id }}">å‰Šé™¤</a>
            </div>
          </div>
        {% endfor %}
      </div>
      <!-- /child-cards -->
    </div>
  {% endfor %}
</div>


<!-- âœ… ã‚¦ã‚©ãƒƒãƒå‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="watch-delete-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.6); z-index:1000;">
  <div style="background:#fff; padding:20px; margin:15% auto; width:300px; border-radius:8px; text-align:center;">
    <p>ã“ã®éŠ˜æŸ„ã¯ã‚¦ã‚©ãƒƒãƒä¸­ã§ã™ã€‚<br>ä¸Šæ›¸ãã—ã¦ã‚¦ã‚©ãƒƒãƒä¸­ã®éŠ˜æŸ„ã‚’ä¸€è¦§ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</p>
    <button id="watch-confirm-delete" style="margin:10px;">ã¯ã„</button>
    <button id="watch-cancel" style="margin:10px;">ã„ã„ãˆ</button>
  </div>
</div>





<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆåå¯¾å£²è²·å…¥åŠ›ï¼‰ -->
<div id="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.6); z-index:999;">
  <div style="background:#fff; padding:20px; margin:10% auto; width:300px; position:relative;">
    <h3 id="modal-title">åå¯¾å£²è²·</h3>
    <form id="modal-form" method="POST" action="/form">
      <input type="hidden" name="parent_id" id="modal-parent-id">
      <input type="hidden" name="type" id="modal-type">
      <input type="hidden" name="purpose" id="modal-purpose">
<div>
  <label>éŠ˜æŸ„åï¼š<input type="text" name="stock" id="modal-stock" readonly style="background:#eee; color:#888;" required></label>
</div>
<div>
  <label>æ ªä¾¡ï¼š<input type="text" name="price" id="modal-price" required></label>
</div>
<div>
  <label>æ•°é‡ï¼š<input type="text" name="quantity" id="modal-quantity" required></label>
</div>
      <div>
        <div>
        <label>æ—¥ä»˜ï¼š<input type="date" name="date" required></label>
      </div>
        <label>æ„Ÿæƒ…ï¼š
          <select name="feeling" id="feeling-select" required>
            {% for feeling in exit_feelings %}
              <option value="{{ loop.index0 }}">{{ feeling }}</option>
            {% endfor %}
          </select>
        </label>
      </div>
      <div>
        <label>ãƒ¡ãƒ¢ï¼š<textarea name="memo"></textarea></label>
      </div>
      <button type="submit">ç™»éŒ²</button>
      <button type="button" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </form>
  </div>
</div>


<!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šç¨®åˆ¥çµ±ä¸€ã€æ„Ÿæƒ…ãƒ»ç›®çš„ã‚»ãƒ¬ã‚¯ãƒˆã€å–å¼•é¡ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆãªã©å¯¾å¿œ -->
<div id="edit-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.6); z-index:1001;">
  <div style="background:#fff; padding:20px; margin:5% auto; width:320px; border-radius:8px; text-align:center;">
    <h3>å–å¼•å†…å®¹ã‚’ç·¨é›†</h3>
    <form id="edit-form" method="POST" action="/form">
      <input type="hidden" name="edit_id" id="edit-id" value="{{ edit_id or '' }}">
      <input type="hidden" name="parent_id" id="edit-parent-id" value="">

      <!-- ç¨®åˆ¥ï¼šé¸æŠå¼ï¼‹æ–‡è¨€çµ±ä¸€ï¼ˆè²·ã„ï¼å£²ã‚Šï¼‰ -->
      <label>ç¨®åˆ¥ï¼š
        <select name="type" id="edit-type" required>
          <option value="buy" {% if edit_type == 'buy' %}selected{% endif %}>è²·ã„</option>
          <option value="sell" {% if edit_type == 'sell' %}selected{% endif %}>å£²ã‚Š</option>
        </select>
      </label><br>



      <!-- éŠ˜æŸ„åï¼ˆstockï¼‰ -->
        <div id="edit-stock-wrap">
        <label>éŠ˜æŸ„åï¼š
        <input type="text" name="stock" id="edit-stock">
        </label>
        </div>

      <!-- ã‚³ãƒ¼ãƒ‰ -->

            <div id="edit-code-wrap">
       <label>ã‚³ãƒ¼ãƒ‰ï¼š<input type="text" name="code" id="edit-code" value="{{ edit_code or '' }}"></label><br>
        </div>



      <!-- æ ªä¾¡ãƒ»æ•°é‡ï¼šæ•´æ•°ã®ã¿ã€å°æ•°ç‚¹ä¸å¯ã€‚å¢—æ¸›ãƒœã‚¿ãƒ³å»ƒæ­¢ã€‚ -->
      <label>æ ªä¾¡ï¼š<input type="text" name="price" id="edit-price" value="{{ edit_price|default('') }}" ></label><br>
      <label>æ•°é‡ï¼š<input type="text" name="quantity" id="edit-quantity" value="{{ edit_quantity or '' }}" ></label><br>

      <!-- å–å¼•é¡ï¼šã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆï¼ˆè‡ªå‹•è¨ˆç®—ã®ã¿ãƒ»å…¥åŠ›ä¸å¯ï¼‰ -->
      <label>å–å¼•é¡ï¼š<input type="text" name="total" id="edit-total" value="{{ edit_total|default('') }}" readonly style="background:#eee; color:#888;"></label><br>

      <label>æ—¥ä»˜ï¼š<input type="date" name="date" id="edit-date" value="{{ edit_date or '' }}"></label><br>

      <!-- æ„Ÿæƒ…ï¼šã‚»ãƒ¬ã‚¯ãƒˆå¼ã«å¤‰æ›´ -->
      <label>æ„Ÿæƒ…ï¼š
        <select name="feeling" id="edit-feeling">
          <option value="1" {% if edit_feeling == '1' %}selected{% endif %}>ğŸ˜– ãƒã‚¬ãƒ†ã‚£ãƒ–</option>
          <option value="2" {% if edit_feeling == '2' %}selected{% endif %}>ğŸ˜ ã‚„ã‚„ä¸å®‰</option>
          <option value="3" {% if edit_feeling == '3' %}selected{% endif %}>ğŸ˜ ãµã¤ã†</option>
          <option value="4" {% if edit_feeling == '4' %}selected{% endif %}>ğŸ™‚ ã¾ã‚ã¾ã‚</option>
          <option value="5" {% if edit_feeling == '5' %}selected{% endif %}>ğŸ˜„ ãƒãƒƒãƒ”ãƒ¼</option>
        </select>
      </label><br>





        <div id="edit-purpose-wrap">
        <label>ç›®çš„ï¼š
        <select name="purpose" id="edit-purpose">
      <option value="short" {% if edit_purpose == 'short' %}selected{% endif %}>ğŸ’¹ çŸ­æœŸ</option>
      <option value="middle" {% if edit_purpose == 'middle' %}selected{% endif %}>ğŸ“Š ä¸­æœŸ</option>
      <option value="long" {% if edit_purpose == 'long' %}selected{% endif %}>ğŸ“ˆ é•·æœŸ</option>
      <option value="benefit" {% if edit_purpose == 'benefit' %}selected{% endif %}>ğŸ å„ªå¾…</option>
      <option value="dividend" {% if edit_purpose == 'dividend' %}selected{% endif %}>ğŸ’° é…å½“</option>
      <option value="" {% if not edit_purpose %}selected{% endif %}>--æœªè¨­å®š--</option>
    </select>
  </label><br>
</div>

      <label>ãƒ¡ãƒ¢ï¼š<textarea name="memo" id="edit-memo">{{ edit_memo or '' }}</textarea></label><br>
      <button type="submit">ä¿å­˜</button>
      <button type="button" onclick="closeEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </form>
  </div>
</div>





<script>
  // Pythonã‹ã‚‰å€¤ã‚’å—ã‘å–ã‚‹å®‰å…¨ãªæ–¹æ³•
  const watchToDelete = {{ (watch_to_delete or None) | tojson }};
  document.addEventListener("DOMContentLoaded", function() {
  if (watchToDelete) {
    showWatchDeleteModal(watchToDelete);
  }
  });

  // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆè¦ªã‚‚å­ã‚‚ .edit-link å…±é€šï¼‰
document.querySelectorAll('.edit-link').forEach(function(btn) {
  btn.addEventListener('click', function(e) {
    e.preventDefault();
    console.log('ã‚¯ãƒªãƒƒã‚¯ã—ãŸè¦ªã‚«ãƒ¼ãƒ‰ã®purpose:', btn.dataset.purpose);

    // â˜…ã“ã“ã‚’è¿½åŠ ï¼æ—¥æœ¬èªâ†’è‹±èªã®purposeå¤‰æ›ãƒãƒƒãƒ—
    const purposeMap = {
      'çŸ­æœŸ': 'short',
      'ä¸­æœŸ': 'middle',
      'é•·æœŸ': 'long',
      'å„ªå¾…': 'benefit',
      'é…å½“': 'dividend',
      'short': 'short',
      'middle': 'middle',
      'long': 'long',
      'benefit': 'benefit',
      'dividend': 'dividend',
      '': ''
    };
    // data-purposeå€¤ãŒæ—¥æœ¬èªã§ã‚‚è‹±èªã§ã‚‚å¿…ãšvalueå±æ€§ã«åˆã†å€¤ã«å¤‰æ›
    let purposeValue = btn.dataset.purpose || '';
    purposeValue = purposeMap[purposeValue] !== undefined ? purposeMap[purposeValue] : '';

    // æ—¢å­˜ã®å€¤ã‚»ãƒƒãƒˆ
    document.getElementById('edit-id').value = btn.dataset.id || '';
    document.getElementById('edit-type').value = btn.dataset.type || '';
    document.getElementById('edit-stock').value = btn.dataset.stock || '';
    document.getElementById('edit-code').value = btn.dataset.code || '';
    document.getElementById('edit-price').value = btn.dataset.price || '';
    document.getElementById('edit-quantity').value = btn.dataset.quantity || '';
    document.getElementById('edit-total').value = btn.dataset.total || '';
    document.getElementById('edit-date').value = btn.dataset.date || '';
    document.getElementById('edit-feeling').value = btn.dataset.feeling || '';
    document.getElementById('edit-parent-id').value = btn.dataset.parentId || '';
    // â˜…ä¿®æ­£ï¼šç›®çš„ã ã‘å¤‰æ›å¾Œã‚’ã‚»ãƒƒãƒˆï¼
    document.getElementById('edit-purpose').value = purposeValue;
    document.getElementById('edit-memo').value = btn.dataset.memo || '';

    // è¦ªã‚«ãƒ¼ãƒ‰ã ã‘ã‚³ãƒ¼ãƒ‰ãƒ»ç›®çš„æ¬„ã‚’è¡¨ç¤º
    const isParent = !btn.closest('.trade-card').classList.contains('child');
    document.getElementById('edit-code-wrap').style.display = isParent ? '' : 'none';
    document.getElementById('edit-purpose-wrap').style.display = isParent ? '' : 'none';
    // --- éŠ˜æŸ„åinputã®ç·¨é›†å¯å¦ï¼†è‰²ã‚’åˆ‡ã‚Šæ›¿ãˆ ---
    if (isParent) {
    // è¦ªã‚«ãƒ¼ãƒ‰ï¼šç·¨é›†å¯ãƒ»é€šå¸¸è‰²
     document.getElementById('edit-stock').readOnly = false;
     document.getElementById('edit-stock').style.background = '';
     document.getElementById('edit-stock').style.color = '';
    } else {
     // å­ã‚«ãƒ¼ãƒ‰ï¼šç·¨é›†ä¸å¯ï¼†ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆ
       document.getElementById('edit-stock').readOnly = true;
       document.getElementById('edit-stock').style.background = '#eee';
       document.getElementById('edit-stock').style.color = '#888';
    }







    document.getElementById('edit-modal').classList.add('show');
  });
});

  // è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆè¦ªã‚«ãƒ¼ãƒ‰ã§ã®å£²ã‚Šãƒ»è²·ã„ï¼‰
  document.querySelectorAll('.open-modal').forEach(btn => {
    btn.addEventListener('click', () => {
      document.getElementById("modal").classList.add("show");
      document.getElementById("modal-parent-id").value = btn.dataset.id;
      document.getElementById("modal-type").value = btn.dataset.type;
      document.getElementById("modal-title").innerText = btn.dataset.type === "buy" ? "è²·ã„" : "å£²ã‚Š";
      document.getElementById("modal-stock").value = btn.dataset.stock;
      document.getElementById("modal-price").value = btn.dataset.price;
      document.getElementById("modal-quantity").value = btn.dataset.quantity;
      const today = new Date().toISOString().split('T')[0];
      document.querySelector('#modal input[name="date"]').value = today;
      document.getElementById("modal-purpose").value = btn.dataset.purpose || "";
    });
  });

  // ã‚¦ã‚©ãƒƒãƒå‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ«
  function showWatchDeleteModal(watchId) {
    const modal = document.getElementById("watch-delete-modal");
    modal.classList.add("show");
    document.getElementById("watch-confirm-delete").onclick = () => {
      window.location.href = '/delete/' + watchId;
    };
    document.getElementById("watch-cancel").onclick = () => {
      modal.classList.remove("show");
    };
  }

  // å…±é€šï¼šé–‰ã˜ã‚‹
  function closeModal() {
    document.getElementById("modal").classList.remove("show");
  }
  function closeEditModal() {
    document.getElementById("edit-modal").classList.remove("show");
  }
</script>


<!-- å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="delete-confirm-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.2); z-index:2000;">
  <div style="background:white; max-width:320px; margin:100px auto; padding:2em; border-radius:10px; text-align:center;">
    <div style="font-size:1.1em; margin-bottom:1em;">æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ<br>ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</div>
    <button id="confirm-delete-btn" style="background:#d32f2f; color:#fff; border:none; padding:0.7em 2em; border-radius:5px; margin:0 1em;">å‰Šé™¤</button>
    <button id="cancel-delete-btn" style="background:#bbb; color:#222; border:none; padding:0.7em 2em; border-radius:5px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<script>
let deleteTargetHref = null;
document.querySelectorAll('.delete-link').forEach(btn => {
  btn.addEventListener('click', function(e) {
    e.preventDefault();
    deleteTargetHref = btn.getAttribute('data-href');
    document.getElementById('delete-confirm-modal').style.display = 'block';
  });
});
document.getElementById('confirm-delete-btn').onclick = function() {
  if (deleteTargetHref) {
    window.location.href = deleteTargetHref;
  }
};
document.getElementById('cancel-delete-btn').onclick = function() {
  document.getElementById('delete-confirm-modal').style.display = 'none';
  deleteTargetHref = null;
};
</script>

<script>
document.querySelectorAll('.toggle-children').forEach(function(toggleBtn, idx) {
  toggleBtn.addEventListener('click', function(e) {
    e.stopPropagation(); // è¦ªã‚«ãƒ¼ãƒ‰ã®ä»–ã‚¤ãƒ™ãƒ³ãƒˆã¨å¹²æ¸‰ã•ã›ãªã„
    // ã“ã®ãƒœã‚¿ãƒ³ã®è¦ª .trade-cardï¼ˆè¦ªã‚«ãƒ¼ãƒ‰ï¼‰ã®ä¸­ã«ã‚ã‚‹ .children-wrap ã‚’æ¢ã™
    const parentCard = toggleBtn.closest('.trade-card');
    const childrenDiv = parentCard.querySelector('.children-wrap');
    if (!childrenDiv) return;
    if (childrenDiv.style.display === 'none') {
      childrenDiv.style.display = '';
      toggleBtn.textContent = 'â–¼';
    } else {
      childrenDiv.style.display = 'none';
      toggleBtn.textContent = 'â–¶';
    }
  });
});

function toggleChildren(badge) {
  const parentCard = badge.closest('.trade-card');
  const childrenDiv = parentCard.querySelector('.children-wrap');
  if (!childrenDiv) return;
  const visible = childrenDiv.style.display !== 'none' && !childrenDiv.classList.contains('collapsed');
  if (visible) {
    childrenDiv.style.display = 'none';
    childrenDiv.classList.add('collapsed');
    badge.textContent = 'ï¼‹ è¿½åŠ å£²è²·å±¥æ­´ã‚ã‚Šï¼ˆã‚¿ãƒƒãƒ—ã§è¡¨ç¤ºï¼‰';
  } else {
    childrenDiv.style.display = '';
    childrenDiv.classList.remove('collapsed');
    badge.textContent = 'â–² è¿½åŠ å£²è²·å±¥æ­´ã‚’é–‰ã˜ã‚‹';
  }
}





</script>

<!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º -->
{% if page is defined and total_pages is defined and total_pages > 1 %}
  <div class="pagination" style="text-align:center; margin: 16px 0;">
    {% if page > 1 %}
      <a href="?page={{ page - 1 }}">Â« å‰ã¸</a>
    {% endif %}
    <span style="margin:0 8px;">{{ page }} / {{ total_pages }}</span>
    {% if page < total_pages %}
      <a href="?page={{ page + 1 }}">æ¬¡ã¸ Â»</a>
    {% endif %}
  </div>
{% endif %}



<!-- è¶…éå£²å´ã‚¨ãƒ©ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="error-alert-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:3000;">
  <div style="background:#fff; padding:24px 16px; margin:15% auto; width:320px; border-radius:10px; text-align:center;">
    <div id="error-alert-msg" style="margin-bottom:16px; color:#b81c1c; font-weight:bold;">
      <!-- ã“ã“ã«ã‚¨ãƒ©ãƒ¼å†…å®¹ãŒå…¥ã‚‹ -->
    </div>
    <button onclick="closeErrorAlert()" style="padding:0.5em 2em; background:#e55151; color:#fff; border:none; border-radius:5px;">OK</button>
  </div>
</div>
<script>
function closeErrorAlert() {
  document.getElementById('error-alert-modal').style.display = 'none';
}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  {% if error_msg %}
    // è­¦å‘Šãƒ¢ãƒ¼ãƒ€ãƒ«ã§ã‚¨ãƒ©ãƒ¼å†…å®¹ã‚’è¡¨ç¤º
    document.getElementById('error-alert-msg').textContent = "{{ error_msg|escape }}";
    document.getElementById('error-alert-modal').style.display = 'block';
  {% endif %}
});




document.addEventListener("DOMContentLoaded", () => {

  /* 
  document.querySelectorAll('.trade-card.parent').forEach(parentCard => {
    parentCard.addEventListener('click', function(e) {
      // ã‚¯ãƒªãƒƒã‚¯å…ƒãŒç·¨é›†ãƒ»å‰Šé™¤ãƒªãƒ³ã‚¯ãªã©ã ã£ãŸå ´åˆã¯ç„¡è¦–
      if (e.target.closest('.edit-link, .delete-link, .action-btn')) return;

      const tradeId = this.getAttribute('data-trade-id');
      const children = document.querySelector(`.children-wrap[data-trade-id='${tradeId}']`);
      if (children) {
        children.classList.toggle('collapsed');

        // ãƒ©ãƒ™ãƒ«è¡¨ç¤ºã‚‚æ›´æ–°ï¼ˆoptionalï¼‰
        const badge = this.querySelector('.has-children-badge');
        if (badge) {
          if (children.classList.contains('collapsed')) {
            badge.textContent = 'ï¼‹ è¿½åŠ å£²è²·å±¥æ­´ã‚ã‚Šï¼ˆã‚¿ãƒƒãƒ—ã§è¡¨ç¤ºï¼‰';
          } else {
            badge.textContent = 'â–² è¿½åŠ å£²è²·å±¥æ­´ã‚’é–‰ã˜ã‚‹';
          }
        }
      }
    });
  });
  */
});


  // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³æŠ¼ä¸‹ã§å…¨ä»¶è¡¨ç¤ºï¼ˆãƒªãƒ­ãƒ¼ãƒ‰ï¼‰
  document.getElementById('clear-button').onclick = function() {
    window.location.href = '/history';
  };

// å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼šãƒ•ã‚©ãƒ¼ãƒ ã®åˆæœŸå€¤ã¨ç¾åœ¨å€¤ã‚’æ¯”è¼ƒ
function isFormDirty(formId) {
  const form = document.getElementById(formId);
  if (!form) return false;
  for (const el of form.elements) {
    if (el.type === "hidden" || el.type === "button" || el.type === "submit") continue;
    if (el.type === "checkbox" || el.type === "radio") {
      if (el.checked !== el.defaultChecked) return true;
    } else {
      if (el.value !== el.defaultValue) return true;
    }
  }
  return false;
}

// â‘  ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨
document.getElementById('edit-modal').addEventListener('mousedown', function(e) {
  if (e.target === this) { // èƒŒæ™¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã ã‘
    if (isFormDirty('edit-form')) {
      if (!confirm("ç·¨é›†å†…å®¹ãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚æœ¬å½“ã«é–‰ã˜ã¾ã™ã‹ï¼Ÿ")) return;
    }
    closeEditModal();
  }
});

// â‘¡ è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨
document.getElementById('modal').addEventListener('mousedown', function(e) {
  if (e.target === this) {
    // ã“ã£ã¡ã¯åŸºæœ¬çš„ã«æœªå…¥åŠ›ã§OKã ãŒã€åŒã˜ããƒ€ãƒ¼ãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã—ãŸã‘ã‚Œã°ä¸‹ã‚’æœ‰åŠ¹ã«
    // if (isFormDirty('modal-form-id')) {
    //   if (!confirm("å…¥åŠ›å†…å®¹ãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚æœ¬å½“ã«é–‰ã˜ã¾ã™ã‹ï¼Ÿ")) return;
    // }
    closeModal();
  }
});



</script>

<script>
function toggleMemo(event, btn, id) {
  event.stopPropagation();
  var elem = document.getElementById(id);
  if (!elem) return;
  if (elem.style.display === "none" || elem.style.display === "") {
    elem.style.display = "block";
    btn.textContent = "â–²";
  } else {
    elem.style.display = "none";
    btn.textContent = "â–¼";
  }
}

// è¿½åŠ å£²è²·å±¥æ­´ãƒãƒƒã‚¸ã®ã¿ã§å­ã‚«ãƒ¼ãƒ‰é–‹é–‰ã™ã‚‹
document.querySelectorAll('.has-children-badge').forEach(badge => {
  badge.addEventListener('click', function(e) {
    e.stopPropagation(); // å¿µã®ãŸã‚
    const parentCard = badge.closest('.trade-card');
    const tradeId = parentCard.getAttribute('data-trade-id');
    const children = document.querySelector(`.children-wrap[data-trade-id='${tradeId}']`);
    if (!children) return;
    const isCollapsed = children.classList.toggle('collapsed');
    // ãƒãƒƒã‚¸ãƒ©ãƒ™ãƒ«æ›´æ–°
    if (isCollapsed) {
      badge.textContent = 'ï¼‹ è¿½åŠ å£²è²·å±¥æ­´ã‚ã‚Šï¼ˆã‚¿ãƒƒãƒ—ã§è¡¨ç¤ºï¼‰';
    } else {
      badge.textContent = 'â–² è¿½åŠ å£²è²·å±¥æ­´ã‚’é–‰ã˜ã‚‹';
    }
  });
});

const feelingColors = ["#e53935", "#ef5350", "#bdbdbd", "#64b5f6", "#1976d2"];
document.getElementById('feeling-select').addEventListener('change', function(e){
    const sel = e.target;
    sel.style.backgroundColor = feelingColors[sel.selectedIndex];
    sel.style.color = (sel.selectedIndex === 2 ? "#222" : "#fff");
});




</script>







{% endblock %}